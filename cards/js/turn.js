/*
 * Copyright (c) 2021 David Beswick.
 *
 * This file is part of cards-mp
 * (see https://github.com/dlbeswick/cards-mp).
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU Affero General Public License as
 * published by the Free Software Foundation, either version 3 of the
 * License, or (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU Affero General Public License for more details.
 *
 * You should have received a copy of the GNU Affero General Public License
 * along with this program. If not, see <http://www.gnu.org/licenses/>.
 */
import { assert } from './assert.js';
import * as array from './array.js';
import * as it from "./iterator.js";
import * as set from './set.js';
import { ConflictResolution, Playfield, deserializeMove, } from "./game.js";
export class Turn {
    constructor(playfield, sequence, moves, invalidated = new Set()) {
        this.playfield = playfield;
        this.sequence = sequence;
        this.moves = moves;
        this.invalidated = invalidated;
    }
    get isEmpty() {
        return this.moves.length == 0;
    }
    get isValid() {
        return this.moves.some(move => this.moves.some(other => move.isConflictingWith(other))) == false;
    }
    get nextPlayfield() {
        assert(this.isValid);
        return this.moves.
            reduce((pf, move) => move.apply(pf), this.playfield).
            withTurnSequence(this.playfield.sequence + 1);
    }
    withMove(move) {
        return new Turn(this.playfield, this.sequence, this.moves.concat(move));
    }
    withConflictsRemoved(invalidated) {
        const unionInvalidated = set.union(this.invalidated, invalidated);
        const [nonConflict, conflict] = array.partition(this.moves, move => it.some(unionInvalidated, c => move.isConflictingWith(c)));
        return new Turn(this.playfield, this.sequence, nonConflict, set.union(new Set(conflict), unionInvalidated));
    }
    withConflictsResolved() {
        const f = (lhs, items, result, removed) => {
            let tail = items;
            while (tail.length != 0) {
                const item = tail[0];
                switch (lhs.resolveConflictWith(item)) {
                    case ConflictResolution.BOTH_STAY:
                        break;
                    case ConflictResolution.LEFT_STAY:
                        return f(lhs, array.remove(items, item), result, removed.concat([item]));
                    case ConflictResolution.RIGHT_STAY:
                        return f(items[0], items.slice(1), result, removed.concat([item]));
                    case ConflictResolution.BOTH_REMOVE:
                        return f(items[0], array.remove(items.slice(1), item), result, removed);
                    default:
                        assert(false);
                }
                tail = items.slice(1);
            }
            if (items.length == 0)
                return [result.concat(lhs), removed];
            else
                return f(items[0], items.slice(1), result.concat(lhs), removed);
        };
        const [resolved, removed] = f(this.moves[0], this.moves.slice(1), [], []);
        return new Turn(this.playfield, this.sequence, resolved, new Set(removed));
    }
    withPlayfield(playfield) {
        return new Turn(playfield, this.sequence, this.moves, this.invalidated);
    }
    serialize() {
        return {
            playfield: this.playfield.serialize(),
            sequence: this.sequence,
            moves: this.moves.map(m => m.serialize())
        };
    }
    static fromSerialized(s) {
        const pf = Playfield.fromSerialized(s.playfield);
        return new Turn(pf, s.sequence, s.moves.map((m) => deserializeMove(m)));
    }
}
export class Gameplay {
    constructor() {
        this._turns = [new Turn(new Playfield(0, [], []), 0, [])];
    }
    turnsReplay(fromIdx) {
        const turnsProcessed = [];
        // Process turns until reaching the head of the turn list, as long as the head is empty.
        // If the head isn't empty, create a new empty head at the end of the list.
        for (let turnIdx = fromIdx; turnIdx < this._turns.length && !(turnIdx == this._turns.length - 1 && this._turns[turnIdx].isEmpty);) {
            const turn = this._turns[turnIdx];
            if (turn.isValid) {
                if (turn.isEmpty && turnIdx == this._turns.length - 1) {
                    break;
                }
                const pf = turn.nextPlayfield;
                assert(pf);
                if (turnIdx == this._turns.length - 1)
                    this._turns[turnIdx + 1] = new Turn(pf, pf.sequence, []);
                else
                    this._turns[turnIdx + 1] = this._turns[turnIdx + 1].withPlayfield(pf);
                assert(this._turns[turnIdx + 1].sequence - this._turns[turnIdx].sequence == 1);
                turnsProcessed.push(this._turns[turnIdx]);
                ++turnIdx;
            }
            else {
                const resolved = turn.withConflictsResolved();
                this._turns[turnIdx] = resolved;
                let invalidated = resolved.invalidated;
                for (let turnIdx2 = fromIdx + 1; turnIdx2 < this._turns.length; ++turnIdx2) {
                    this._turns[turnIdx2] = this._turns[turnIdx2].withConflictsRemoved(invalidated);
                    invalidated = this._turns[turnIdx2].invalidated;
                }
            }
            assert(turnIdx == this._turns.length || this._turns[turnIdx].isValid);
        }
        this._turns.reduce((a, b) => {
            assert(b.sequence - a.sequence == 1, "Turns out-of-sequence");
            return b;
        });
        return turnsProcessed;
    }
    get turnCurrent() {
        assert(this._turns.length > 0);
        return this._turns[this._turns.length - 1];
    }
    get playfield() {
        return this.turnCurrent.playfield;
    }
    get turns() {
        return Array.from(this._turns);
    }
    newGame(turns) {
        this._turns = Array.from(turns);
    }
    hasSequence(sequence) {
        return this._turns.findIndex(t => t.sequence == sequence) != -1;
    }
    restateTurn(turn) {
        const idx = this._turns.findIndex(t => t.sequence == turn.sequence);
        assert(idx != -1);
        this._turns[idx] = turn;
        this.turnsReplay(idx);
    }
    integrateMove(move) {
        console.debug("Integrate move at sequence", move.turnSequence, move.items, move.idSource, move.idDest);
        const slotsChanged = new Set();
        let turnsProcessed;
        let turnIdx = this._turns.findIndex(t => t.sequence == move.turnSequence);
        assert(turnIdx != -1);
        this._turns[turnIdx] = this._turns[turnIdx].withMove(move);
        turnsProcessed = this.turnsReplay(turnIdx);
        if (this._turns.length > 100)
            this._turns.shift();
        for (const turn of turnsProcessed) {
            for (const move of turn.moves) {
                move.slotsChanged.forEach(s => slotsChanged.add(s));
            }
        }
        return slotsChanged;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHVybi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3RzL3R1cm4udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7Ozs7Ozs7Ozs7Ozs7OztHQWtCRztBQUNILE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxhQUFhLENBQUE7QUFDcEMsT0FBTyxLQUFLLEtBQUssTUFBTSxZQUFZLENBQUE7QUFDbkMsT0FBTyxLQUFLLEVBQUUsTUFBTSxlQUFlLENBQUE7QUFDbkMsT0FBTyxLQUFLLEdBQUcsTUFBTSxVQUFVLENBQUE7QUFDL0IsT0FBTyxFQUNMLGtCQUFrQixFQUFnQixTQUFTLEVBQUUsZUFBZSxHQUM3RCxNQUFNLFdBQVcsQ0FBQTtBQUVsQixNQUFNLE9BQU8sSUFBSTtJQUNmLFlBQ1csU0FBb0IsRUFDcEIsUUFBZ0IsRUFDaEIsS0FBOEIsRUFDOUIsY0FBaUMsSUFBSSxHQUFHLEVBQUU7UUFIMUMsY0FBUyxHQUFULFNBQVMsQ0FBVztRQUNwQixhQUFRLEdBQVIsUUFBUSxDQUFRO1FBQ2hCLFVBQUssR0FBTCxLQUFLLENBQXlCO1FBQzlCLGdCQUFXLEdBQVgsV0FBVyxDQUErQjtJQUNsRCxDQUFDO0lBRUosSUFBSSxPQUFPO1FBQ1QsT0FBTyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUE7SUFDL0IsQ0FBQztJQUVELElBQUksT0FBTztRQUNULE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsRUFBRSxDQUFDLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksS0FBSyxDQUFBO0lBQ2xHLENBQUM7SUFFRCxJQUFJLGFBQWE7UUFDZixNQUFNLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFBO1FBRXBCLE9BQU8sSUFBSSxDQUFDLEtBQUs7WUFD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QzdCLElBQUksQ0FBQyxZQUFZLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsWUFBWSxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO2FBQ3BEO1NBQ0Y7UUFFRCxPQUFPLFlBQVksQ0FBQTtJQUNyQixDQUFDO0NBQ0YiLCJzb3VyY2VzQ29udGVudCI6WyIvKlxuICogQ29weXJpZ2h0IChjKSAyMDIxIERhdmlkIEJlc3dpY2suXG4gKlxuICogVGhpcyBmaWxlIGlzIHBhcnQgb2YgY2FyZHMtbXAgXG4gKiAoc2VlIGh0dHBzOi8vZ2l0aHViLmNvbS9kbGJlc3dpY2svY2FyZHMtbXApLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBmcmVlIHNvZnR3YXJlOiB5b3UgY2FuIHJlZGlzdHJpYnV0ZSBpdCBhbmQvb3IgbW9kaWZ5XG4gKiBpdCB1bmRlciB0aGUgdGVybXMgb2YgdGhlIEdOVSBBZmZlcm8gR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBhc1xuICogcHVibGlzaGVkIGJ5IHRoZSBGcmVlIFNvZnR3YXJlIEZvdW5kYXRpb24sIGVpdGhlciB2ZXJzaW9uIDMgb2YgdGhlXG4gKiBMaWNlbnNlLCBvciAoYXQgeW91ciBvcHRpb24pIGFueSBsYXRlciB2ZXJzaW9uLlxuICpcbiAqIFRoaXMgcHJvZ3JhbSBpcyBkaXN0cmlidXRlZCBpbiB0aGUgaG9wZSB0aGF0IGl0IHdpbGwgYmUgdXNlZnVsLFxuICogYnV0IFdJVEhPVVQgQU5ZIFdBUlJBTlRZOyB3aXRob3V0IGV2ZW4gdGhlIGltcGxpZWQgd2FycmFudHkgb2ZcbiAqIE1FUkNIQU5UQUJJTElUWSBvciBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRS4gIFNlZSB0aGVcbiAqIEdOVSBBZmZlcm8gR2VuZXJhbCBQdWJsaWMgTGljZW5zZSBmb3IgbW9yZSBkZXRhaWxzLlxuICpcbiAqIFlvdSBzaG91bGQgaGF2ZSByZWNlaXZlZCBhIGNvcHkgb2YgdGhlIEdOVSBBZmZlcm8gR2VuZXJhbCBQdWJsaWMgTGljZW5zZVxuICogYWxvbmcgd2l0aCB0aGlzIHByb2dyYW0uIElmIG5vdCwgc2VlIDxodHRwOi8vd3d3LmdudS5vcmcvbGljZW5zZXMvPi5cbiAqL1xuaW1wb3J0IHsgYXNzZXJ0IH0gZnJvbSAnLi9hc3NlcnQuanMnXG5pbXBvcnQgKiBhcyBhcnJheSBmcm9tICcuL2FycmF5LmpzJ1xuaW1wb3J0ICogYXMgaXQgZnJvbSBcIi4vaXRlcmF0b3IuanNcIlxuaW1wb3J0ICogYXMgc2V0IGZyb20gJy4vc2V0LmpzJ1xuaW1wb3J0IHtcbiAgQ29uZmxpY3RSZXNvbHV0aW9uLCBNb3ZlSXRlbXNBbnksIFBsYXlmaWVsZCwgZGVzZXJpYWxpemVNb3ZlLCBcbn0gZnJvbSBcIi4vZ2FtZS5qc1wiXG5cbmV4cG9ydCBjbGFzcyBUdXJuIHtcbiAgY29uc3RydWN0b3IoXG4gICAgcmVhZG9ubHkgcGxheWZpZWxkOiBQbGF5ZmllbGQsXG4gICAgcmVhZG9ubHkgc2VxdWVuY2U6IG51bWJlcixcbiAgICByZWFkb25seSBtb3ZlczogcmVhZG9ubHkgTW92ZUl0ZW1zQW55W10sXG4gICAgcmVhZG9ubHkgaW52YWxpZGF0ZWQ6IFNldDxNb3ZlSXRlbXNBbnk+ID0gbmV3IFNldCgpXG4gICkge31cblxuICBnZXQgaXNFbXB0eSgpIHtcbiAgICByZXR1cm4gdGhpcy5tb3Zlcy5sZW5ndGggPT0gMFxuICB9XG4gIFxuICBnZXQgaXNWYWxpZCgpIHtcbiAgICByZXR1cm4gdGhpcy5tb3Zlcy5zb21lKG1vdmUgPT4gdGhpcy5tb3Zlcy5zb21lKG90aGVyID0+IG1vdmUuaXNDb25mbGljdGluZ1dpdGgob3RoZXIpKSkgPT0gZmFsc2VcbiAgfVxuICBcbiAgZ2V0IG5leHRQbGF5ZmllbGQoKSB7XG4gICAgYXNzZXJ0KHRoaXMuaXNWYWxpZClcblxuICAgIHJldHVybiB0aGlzLm1vdmVzLlxuICAgICAgcmVkdWNlKChwZiwgbW92ZSkgPT4gbW92ZS5hcHBseShwZiksIHRoaXMucGxheWZpZWxkKS5cbiAgICAgIHdpdGhUdXJuU2VxdWVuY2UodGhpcy5wbGF5ZmllbGQuc2VxdWVuY2UgKyAxKVxuICB9XG5cbiAgd2l0aE1vdmUobW92ZTogTW92ZUl0ZW1zQW55KSB7XG4gICAgcmV0dXJuIG5ldyBUdXJuKHRoaXMucGxheWZpZWxkLCB0aGlzLnNlcXVlbmNlLCB0aGlzLm1vdmVzLmNvbmNhdChtb3ZlKSlcbiAgfVxuXG4gIHdpdGhDb25mbGljdHNSZW1vdmVkKGludmFsaWRhdGVkOiBTZXQ8TW92ZUl0ZW1zQW55Pikge1xuICAgIGNvbnN0IHVuaW9uSW52YWxpZGF0ZWQgPSBzZXQudW5pb24odGhpcy5pbnZhbGlkYXRlZCwgaW52YWxpZGF0ZWQpXG4gICAgXG4gICAgY29uc3QgW25vbkNvbmZsaWN0LCBjb25mbGljdF0gPVxuICAgICAgYXJyYXkucGFydGl0aW9uKFxuICAgICAgICB0aGlzLm1vdmVzLFxuICAgICAgICBtb3ZlID0+IGl0LnNvbWUodW5pb25JbnZhbGlkYXRlZCwgYyA9PiBtb3ZlLmlzQ29uZmxpY3RpbmdXaXRoKGMpKVxuICAgICAgKVxuXG4gICAgcmV0dXJuIG5ldyBUdXJuKFxuICAgICAgdGhpcy5wbGF5ZmllbGQsXG4gICAgICB0aGlzLnNlcXVlbmNlLFxuICAgICAgbm9uQ29uZmxpY3QsXG4gICAgICBzZXQudW5pb24obmV3IFNldChjb25mbGljdCksIHVuaW9uSW52YWxpZGF0ZWQpXG4gICAgKVxuICB9XG4gIFxuICB3aXRoQ29uZmxpY3RzUmVzb2x2ZWQoKSB7XG4gICAgY29uc3QgZiA9XG4gICAgICAobGhzOiBNb3ZlSXRlbXNBbnksXG4gICAgICAgaXRlbXM6IHJlYWRvbmx5IE1vdmVJdGVtc0FueVtdLFxuICAgICAgIHJlc3VsdDogcmVhZG9ubHkgTW92ZUl0ZW1zQW55W10sXG4gICAgICAgcmVtb3ZlZDogcmVhZG9ubHkgTW92ZUl0ZW1zQW55W10pOiBbcmVhZG9ubHkgTW92ZUl0ZW1zQW55W10sIHJlYWRvbmx5IE1vdmVJdGVtc0FueVtdXSA9PiB7XG4gICAgICAgIFxuICAgICAgICBsZXQgdGFpbCA9IGl0ZW1zXG4gICAgICAgIHdoaWxlICh0YWlsLmxlbmd0aCAhPSAwKSB7XG4gICAgICAgICAgY29uc3QgaXRlbSA9IHRhaWxbMF1cbiAgICAgICAgICBcbiAgICAgICAgICBzd2l0Y2ggKGxocy5yZXNvbHZlQ29uZmxpY3RXaXRoKGl0ZW0pKSB7XG4gICAgICAgICAgICBjYXNlIENvbmZsaWN0UmVzb2x1dGlvbi5CT1RIX1NUQVk6XG4gICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgY2FzZSBDb25mbGljdFJlc29sdXRpb24uTEVGVF9TVEFZOlxuICAgICAgICAgICAgICByZXR1cm4gZihsaHMsIGFycmF5LnJlbW92ZShpdGVtcywgaXRlbSksIHJlc3VsdCwgcmVtb3ZlZC5jb25jYXQoW2l0ZW1dKSk7XG4gICAgICAgICAgICBjYXNlIENvbmZsaWN0UmVzb2x1dGlvbi5SSUdIVF9TVEFZOlxuICAgICAgICAgICAgICByZXR1cm4gZihpdGVtc1swXSwgaXRlbXMuc2xpY2UoMSksIHJlc3VsdCwgcmVtb3ZlZC5jb25jYXQoW2l0ZW1dKSk7XG4gICAgICAgICAgICBjYXNlIENvbmZsaWN0UmVzb2x1dGlvbi5CT1RIX1JFTU9WRTpcbiAgICAgICAgICAgICAgcmV0dXJuIGYoaXRlbXNbMF0sIGFycmF5LnJlbW92ZShpdGVtcy5zbGljZSgxKSwgaXRlbSksIHJlc3VsdCwgcmVtb3ZlZCk7XG4gICAgICAgICAgICBkZWZhdWx0OlxuICAgICAgICAgICAgICBhc3NlcnQoZmFsc2UpXG4gICAgICAgICAgfVxuICAgICAgICAgIFxuICAgICAgICAgIHRhaWwgPSBpdGVtcy5zbGljZSgxKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGl0ZW1zLmxlbmd0aCA9PSAwKVxuICAgICAgICAgIHJldHVybiBbcmVzdWx0LmNvbmNhdChsaHMpLCByZW1vdmVkXVxuICAgICAgICBlbHNlXG4gICAgICAgICAgcmV0dXJuIGYoaXRlbXNbMF0sIGl0ZW1zLnNsaWNlKDEpLCByZXN1bHQuY29uY2F0KGxocyksIHJlbW92ZWQpXG4gICAgICB9XG5cbiAgICBjb25zdCBbcmVzb2x2ZWQsIHJlbW92ZWRdID0gZih0aGlzLm1vdmVzWzBdLCB0aGlzLm1vdmVzLnNsaWNlKDEpLCBbXSwgW10pXG4gICAgXG4gICAgcmV0dXJuIG5ldyBUdXJuKHRoaXMucGxheWZpZWxkLCB0aGlzLnNlcXVlbmNlLCByZXNvbHZlZCwgbmV3IFNldChyZW1vdmVkKSlcbiAgfVxuICBcbiAgd2l0aFBsYXlmaWVsZChwbGF5ZmllbGQ6IFBsYXlmaWVsZCkge1xuICAgIHJldHVybiBuZXcgVHVybihwbGF5ZmllbGQsIHRoaXMuc2VxdWVuY2UsIHRoaXMubW92ZXMsIHRoaXMuaW52YWxpZGF0ZWQpXG4gIH1cblxuICBzZXJpYWxpemUoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHBsYXlmaWVsZDogdGhpcy5wbGF5ZmllbGQuc2VyaWFsaXplKCksXG4gICAgICBzZXF1ZW5jZTogdGhpcy5zZXF1ZW5jZSxcbiAgICAgIG1vdmVzOiB0aGlzLm1vdmVzLm1hcChtID0+IG0uc2VyaWFsaXplKCkpXG4gICAgfVxuICB9XG5cbiAgc3RhdGljIGZyb21TZXJpYWxpemVkKHM6IGFueSkge1xuICAgIGNvbnN0IHBmID0gUGxheWZpZWxkLmZyb21TZXJpYWxpemVkKHMucGxheWZpZWxkKVxuICAgIHJldHVybiBuZXcgVHVybihcbiAgICAgIHBmLFxuICAgICAgcy5zZXF1ZW5jZSxcbiAgICAgIHMubW92ZXMubWFwKChtOiBhbnkpID0+IGRlc2VyaWFsaXplTW92ZShtKSlcbiAgICApXG4gIH1cbn1cblxuZXhwb3J0IGNsYXNzIEdhbWVwbGF5IHtcbiAgcHJpdmF0ZSBfdHVybnM6IFR1cm5bXSA9IFtuZXcgVHVybihuZXcgUGxheWZpZWxkKDAsIFtdLCBbXSksIDAsIFtdKV1cblxuICBwcml2YXRlIHR1cm5zUmVwbGF5KGZyb21JZHg6IG51bWJlcik6IEFycmF5PFR1cm4+IHtcbiAgICBjb25zdCB0dXJuc1Byb2Nlc3NlZDogQXJyYXk8VHVybj4gPSBbXVxuXG4gICAgLy8gUHJvY2VzcyB0dXJucyB1bnRpbCByZWFjaGluZyB0aGUgaGVhZCBvZiB0aGUgdHVybiBsaXN0LCBhcyBsb25nIGFzIHRoZSBoZWFkIGlzIGVtcHR5LlxuICAgIC8vIElmIHRoZSBoZWFkIGlzbid0IGVtcHR5LCBjcmVhdGUgYSBuZXcgZW1wdHkgaGVhZCBhdCB0aGUgZW5kIG9mIHRoZSBsaXN0LlxuICAgIGZvciAobGV0IHR1cm5JZHggPSBmcm9tSWR4O1xuICAgICAgICAgdHVybklkeCA8IHRoaXMuX3R1cm5zLmxlbmd0aCAmJiAhKHR1cm5JZHggPT0gdGhpcy5fdHVybnMubGVuZ3RoIC0gMSAmJiB0aGlzLl90dXJuc1t0dXJuSWR4XS5pc0VtcHR5KTsgKSB7XG4gICAgICBcbiAgICAgIGNvbnN0IHR1cm4gPSB0aGlzLl90dXJuc1t0dXJuSWR4XVxuICAgICAgaWYgKHR1cm4uaXNWYWxpZCkge1xuICAgICAgICBpZiAodHVybi5pc0VtcHR5ICYmIHR1cm5JZHggPT0gdGhpcy5fdHVybnMubGVuZ3RoIC0gMSkge1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBjb25zdCBwZiA9IHR1cm4ubmV4dFBsYXlmaWVsZFxuICAgICAgICBhc3NlcnQocGYpXG5cbiAgICAgICAgaWYgKHR1cm5JZHggPT0gdGhpcy5fdHVybnMubGVuZ3RoIC0gMSlcbiAgICAgICAgICB0aGlzLl90dXJuc1t0dXJuSWR4KzFdID0gbmV3IFR1cm4ocGYsIHBmLnNlcXVlbmNlLCBbXSlcbiAgICAgICAgZWxzZVxuICAgICAgICAgIHRoaXMuX3R1cm5zW3R1cm5JZHgrMV0gPSB0aGlzLl90dXJuc1t0dXJuSWR4KzFdLndpdGhQbGF5ZmllbGQocGYpXG5cbiAgICAgICAgYXNzZXJ0KHRoaXMuX3R1cm5zW3R1cm5JZHgrMV0uc2VxdWVuY2UgLSB0aGlzLl90dXJuc1t0dXJuSWR4XS5zZXF1ZW5jZSA9PSAxKVxuICAgICAgICBcbiAgICAgICAgdHVybnNQcm9jZXNzZWQucHVzaCh0aGlzLl90dXJuc1t0dXJuSWR4XSlcblxuICAgICAgICArK3R1cm5JZHg7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICBjb25zdCByZXNvbHZlZCA9IHR1cm4ud2l0aENvbmZsaWN0c1Jlc29sdmVkKClcbiAgICAgICAgdGhpcy5fdHVybnNbdHVybklkeF0gPSByZXNvbHZlZFxuXG4gICAgICAgIGxldCBpbnZhbGlkYXRlZCA9IHJlc29sdmVkLmludmFsaWRhdGVkXG4gICAgICAgIGZvciAobGV0IHR1cm5JZHgyID0gZnJvbUlkeCsxOyB0dXJuSWR4MiA8IHRoaXMuX3R1cm5zLmxlbmd0aDsgKyt0dXJuSWR4Mikge1xuICAgICAgICAgIHRoaXMuX3R1cm5zW3R1cm5JZHgyXSA9IHRoaXMuX3R1cm5zW3R1cm5JZHgyXS53aXRoQ29uZmxpY3RzUmVtb3ZlZChpbnZhbGlkYXRlZClcbiAgICAgICAgICBpbnZhbGlkYXRlZCA9IHRoaXMuX3R1cm5zW3R1cm5JZHgyXS5pbnZhbGlkYXRlZFxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIGFzc2VydCh0dXJuSWR4ID09IHRoaXMuX3R1cm5zLmxlbmd0aCB8fCB0aGlzLl90dXJuc1t0dXJuSWR4XS5pc1ZhbGlkKVxuICAgIH1cblxuICAgIHRoaXMuX3R1cm5zLnJlZHVjZSgoYSxiKSA9PiB7XG4gICAgICBhc3NlcnQoYi5zZXF1ZW5jZSAtIGEuc2VxdWVuY2UgPT0gMSwgXCJUdXJucyBvdXQtb2Ytc2VxdWVuY2VcIik7IHJldHVybiBiXG4gICAgfSlcbiAgICBcbiAgICByZXR1cm4gdHVybnNQcm9jZXNzZWRcbiAgfVxuXG4gIGdldCB0dXJuQ3VycmVudCgpIHtcbiAgICBhc3NlcnQodGhpcy5fdHVybnMubGVuZ3RoID4gMClcbiAgICByZXR1cm4gdGhpcy5fdHVybnNbdGhpcy5fdHVybnMubGVuZ3RoIC0gMV1cbiAgfVxuICBcbiAgZ2V0IHBsYXlmaWVsZCgpIHtcbiAgICByZXR1cm4gdGhpcy50dXJuQ3VycmVudC5wbGF5ZmllbGRcbiAgfVxuXG4gIGdldCB0dXJucygpOiByZWFkb25seSBUdXJuW10ge1xuICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMuX3R1cm5zKVxuICB9XG5cbiAgbmV3R2FtZSh0dXJuczogcmVhZG9ubHkgVHVybltdKSB7XG4gICAgdGhpcy5fdHVybnMgPSBBcnJheS5mcm9tKHR1cm5zKVxuICB9XG5cbiAgaGFzU2VxdWVuY2Uoc2VxdWVuY2U6IG51bWJlcikge1xuICAgIHJldHVybiB0aGlzLl90dXJucy5maW5kSW5kZXgodCA9PiB0LnNlcXVlbmNlID09IHNlcXVlbmNlKSAhPSAtMVxuICB9XG5cbiAgcmVzdGF0ZVR1cm4odHVybjogVHVybikge1xuICAgIGNvbnN0IGlkeCA9IHRoaXMuX3R1cm5zLmZpbmRJbmRleCh0ID0+IHQuc2VxdWVuY2UgPT0gdHVybi5zZXF1ZW5jZSlcbiAgICBhc3NlcnQoaWR4ICE9IC0xKVxuICAgIHRoaXMuX3R1cm5zW2lkeF0gPSB0dXJuXG4gICAgdGhpcy50dXJuc1JlcGxheShpZHgpXG4gIH1cbiAgXG4gIGludGVncmF0ZU1vdmUobW92ZTogTW92ZUl0ZW1zQW55KTogU2V0PFtzdHJpbmcsIG51bWJlcl0+IHtcbiAgICBjb25zb2xlLmRlYnVnKFwiSW50ZWdyYXRlIG1vdmUgYXQgc2VxdWVuY2VcIiwgbW92ZS50dXJuU2VxdWVuY2UsIG1vdmUuaXRlbXMsIG1vdmUuaWRTb3VyY2UsIG1vdmUuaWREZXN0KVxuICAgIFxuICAgIGNvbnN0IHNsb3RzQ2hhbmdlZCA9IG5ldyBTZXQ8W3N0cmluZywgbnVtYmVyXT4oKVxuXG4gICAgbGV0IHR1cm5zUHJvY2Vzc2VkOiBBcnJheTxUdXJuPlxuXG4gICAgbGV0IHR1cm5JZHggPSB0aGlzLl90dXJucy5maW5kSW5kZXgodCA9PiB0LnNlcXVlbmNlID09IG1vdmUudHVyblNlcXVlbmNlKVxuICAgIGFzc2VydCh0dXJuSWR4ICE9IC0xKVxuXG4gICAgdGhpcy5fdHVybnNbdHVybklkeF0gPSB0aGlzLl90dXJuc1t0dXJuSWR4XS53aXRoTW92ZShtb3ZlKVxuICAgIHR1cm5zUHJvY2Vzc2VkID0gdGhpcy50dXJuc1JlcGxheSh0dXJuSWR4KVxuICAgIGlmICh0aGlzLl90dXJucy5sZW5ndGggPiAxMDApXG4gICAgICB0aGlzLl90dXJucy5zaGlmdCgpXG5cbiAgICBmb3IgKGNvbnN0IHR1cm4gb2YgdHVybnNQcm9jZXNzZWQpIHtcbiAgICAgIGZvciAoY29uc3QgbW92ZSBvZiB0dXJuLm1vdmVzKSB7XG4gICAgICAgIG1vdmUuc2xvdHNDaGFuZ2VkLmZvckVhY2gocyA9PiBzbG90c0NoYW5nZWQuYWRkKHMpKVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBzbG90c0NoYW5nZWRcbiAgfVxufVxuIl19