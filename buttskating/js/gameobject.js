var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import { assert } from "./assert.js";
import { Pictures } from "./pictures.js";
import { Point2 } from "./point2.js";
import { AABBTester } from "./aabbtester.js";
export class GameObject {
    constructor() {
        this.m_vel = new Point2();
        this.m_pos = new Point2();
        this.m_size = new Point2();
        this.m_animLoopStart = 0;
        this.m_animDone = false;
        this.m_oldCollidePos = new Point2();
        // We need to keep track of our collision records
        this.m_record = new Array(4);
        console.assert(GameObject.m_pCollide != undefined);
        this.m_speed = 0;
        this.m_frame = 0;
        this.m_animPos = 0;
        this.m_animSpeed = 0;
        this.m_animPtr = [];
        this.m_animNum = 0;
        this.m_animPriority = -1;
        this.m_scale = 1.0;
        this.m_layer = 0;
        this.m_bDrawToLayer = true;
    }
    gameMapHit(sx, sy, ex, ey) { return false; }
    getLayerDraw() { return this.m_bDrawToLayer; }
    animDone() { return this.m_animDone; }
    handleCollide(a, b) { }
    destroy() {
        if (this.m_record[0]) {
            GameObject.m_pCollide.removeObj(this.m_record);
            this.m_record = [undefined, undefined, undefined, undefined];
        }
    }
    static initStatic() {
        return __awaiter(this, void 0, void 0, function* () {
            console.assert(!GameObject.m_pCollide);
            GameObject.m_pCollide = new AABBTester();
            // Load sprite coords
            GameObject.m_pictures = yield Pictures.load('media/sprites.txt');
            // Load anim data
            this.m_anims = yield fetch('media/anim.json')
                .then(response => response.json())
                .then(data => data)
                .catch(error => { throw ("Failed to load media/anim.txt: " + error); });
        });
    }
    get rotation() { return 0; }
    draw(ctx) {
        assert(GameObject.m_pictures);
        const f = GameObject.m_pictures.getFrame(this.m_frame);
        ctx.translate(this.m_pos.x - f.width / 2, this.m_pos.y - f.height / 2);
        ctx.translate(f.width / 2, f.height / 2);
        ctx.scale(this.m_scale, this.m_scale);
        ctx.rotate(this.rotation);
        ctx.translate(-f.width / 2, -f.height / 2);
        assert(GameObject.m_pictures);
        ctx.drawImage(f.img, f.x0, f.y0, f.width, f.height, 0, 0, f.width, f.height);
    }
    setAnim(anim, speed, priority = -1) {
        const newAnim = GameObject.m_anims[anim];
        console.assert(newAnim != undefined);
        if (newAnim == this.m_animPtr) {
            this.m_animSpeed = speed;
            this.m_animPriority = priority;
            return;
        }
        if (priority >= this.m_animPriority) {
            this.m_animPtr = newAnim;
            // position at start
            this.m_animPos = 0;
            this.m_animNum = this.m_animPtr.length;
            this.m_animSpeed = speed;
            this.m_animLoopStart = 0;
            this.m_animPriority = priority;
            if (this.m_animPtr[Math.floor(this.m_animPos)] == -2) {
                this.m_animPos++;
                this.m_animLoopStart = this.m_animPos;
            }
            this.m_frame = this.m_animPtr[Math.floor(this.m_animPos)];
            assert(this.m_frame != undefined);
        }
    }
    animate() {
        console.assert(this.m_animPtr != undefined);
        this.m_animDone = false;
        if (this.m_animPos >= this.m_animNum) {
            if (this.m_animLoopStart) {
                this.m_animPos = this.m_animLoopStart;
            }
            else {
                this.m_animPos = this.m_animNum - 1;
                this.m_animDone = true;
            }
        }
        if (this.m_animPtr[Math.floor(this.m_animPos)] == -2) {
            this.m_animPos++;
            this.m_animLoopStart = this.m_animPos;
        }
        this.m_frame = this.m_animPtr[Math.floor(this.m_animPos)];
        assert(this.m_frame != undefined);
        this.m_animPriority = -1;
        this.m_animPos += this.m_animSpeed;
    }
    enterCollisionSystem() {
        this.m_record = GameObject.m_pCollide.addObj(this);
    }
    beginMove() {
        this.m_oldCollidePos = this.m_pos;
    }
    endMove() {
        assert(this.m_record[0] != undefined);
        GameObject.m_pCollide.moveObj(this, this.m_pos.minus(this.m_oldCollidePos), this.m_record);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2FtZW9iamVjdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3RzL2dhbWVvYmplY3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGFBQWEsQ0FBQTtBQUVwQyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFBO0FBQ3hDLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxhQUFhLENBQUE7QUFDcEMsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLGlCQUFpQixDQUFBO0FBRTVDLE1BQU0sT0FBZ0IsVUFBVTtJQXFCOUI7UUFaRCxVQUFLLEdBQUcsSUFBSSxNQUFNLEVBQUUsQ0FBQTtRQUNwQixVQUFLLEdBQUcsSUFBSSxNQUFNLEVBQUUsQ0FBQTtRQUNwQixXQUFNLEdBQUcsSUFBSSxNQUFNLEVBQUUsQ0FBQTtRQW1LYixvQkFBZSxHQUFXLENBQUMsQ0FBQTtRQUszQixlQUFVLEdBQVksS0FBSyxDQUFBO1FBRTNCLG9CQUFlLEdBQUcsSUFBSSxNQUFNLEVBQUUsQ0FBQTtRQUV0QyxpREFBaUQ7UUFDekMsYUFBUSxHQUViLElBQUksS0FBSyxDQUFtQixDQUFDLENBQTZFLENBQUE7UUFwSzNHLE9BQU8sQ0FBQyxNQUFNLENBQUMsVUFBVSxDQUFDLFVBQVUsSUFBSSxTQUFTLENBQUMsQ0FBQTtRQUNsRCxJQUFJLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQztRQUNqQixJQUFJLENBQUMsT0FBTyxHQUFHLENBQUMsQ0FBQztRQUNqQixJQUFJLENBQUMsU0FBUyxHQUFHLENBQUMsQ0FBQztRQUNuQixJQUFJLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQztRQUNyQixJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQztRQUNwQixJQUFJLENBQUMsU0FBUyxHQUFHLENBQUMsQ0FBQztRQUNuQixJQUFJLENBQUMsY0FBYyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBQ3pCLElB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QyxXQUFXLENBQUM7SUFDcEMsQ0FBQztJQUlTLG9CQUFvQjtRQUM3QixJQUFJLENBQUMsUUFBUSxHQUFHLFVBQVUsQ0FBQyxVQUFVLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFBO0lBQ25ELENBQUM7SUFFUyxTQUFTO1FBQ2xCLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQTtJQUNsQyxDQUFDO0lBRVMsT0FBTztRQUNmLE1BQU0sQ0FBQyxJQUFJLENBQUMsUUFBUSxDQUFDLENBQUMsQ0FBQyxJQUFJLFNBQVMsQ0FBQyxDQUFBO1FBQ3RDLFVBQVUsQ0FBQyxVQUFVLENBQUMsT0FBTyxDQUMxQixJQUFJLEVBQ0osSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxFQUN0QyxJQUFJLENBQUMsUUFBb0YsQ0FDMUYsQ0FBQTtJQUNILENBQUM7Q0FvQkYiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBhc3NlcnQgfSBmcm9tIFwiLi9hc3NlcnQuanNcIlxuaW1wb3J0IHsgc1JlYyB9IGZyb20gXCIuL2J1Y2tldC5qc1wiXG5pbXBvcnQgeyBQaWN0dXJlcyB9IGZyb20gXCIuL3BpY3R1cmVzLmpzXCJcbmltcG9ydCB7IFBvaW50MiB9IGZyb20gXCIuL3BvaW50Mi5qc1wiXG5pbXBvcnQgeyBBQUJCVGVzdGVyIH0gZnJvbSBcIi4vYWFiYnRlc3Rlci5qc1wiXG5cbmV4cG9ydCBhYnN0cmFjdCBjbGFzcyBHYW1lT2JqZWN0IHtcblx0YWJzdHJhY3QgZ2FtZVVwZGF0ZSgpOiBib29sZWFuXG4gIGdhbWVNYXBIaXQoc3g6IG51bWJlciwgc3k6IG51bWJlciwgZXg6IG51bWJlciwgZXk6IG51bWJlcikgeyByZXR1cm4gZmFsc2U7IH1cblxuXHRnZXRMYXllckRyYXcoKSB7IHJldHVybiB0aGlzLm1fYkRyYXdUb0xheWVyIH1cblxuXHRtX2ZyYW1lOiBudW1iZXJcblx0bV9zcGVlZDogbnVtYmVyXG5cdG1fc2NhbGU6IG51bWJlclxuXHRtX3ZlbCA9IG5ldyBQb2ludDIoKVxuXHRtX3BvcyA9IG5ldyBQb2ludDIoKVxuXHRtX3NpemUgPSBuZXcgUG9pbnQyKClcblxuXHRtX2xheWVyOiBudW1iZXJcblxuXHRhbmltRG9uZSgpIHsgcmV0dXJuIHRoaXMubV9hbmltRG9uZTsgfVxuXG5cdHN0YXRpYyBtX3BpY3R1cmVzPzogUGljdHVyZXNcblxuXHRoYW5kbGVDb2xsaWRlKGE6IEdhbWVPYmplY3QsIGI6IEdhbWVPYmplY3QpIHt9XG5cbiAgY29uc3RydWN0b3IoKSB7XG5cdCAgY29uc29sZS5hc3NlcnQoR2FtZU9iamVjdC5tX3BDb2xsaWRlICE9IHVuZGVmaW5lZClcblx0ICB0aGlzLm1fc3BlZWQgPSAwO1xuXHQgIHRoaXMubV9mcmFtZSA9IDA7XG5cdCAgdGhpcy5tX2FuaW1Qb3MgPSAwO1xuXHQgIHRoaXMubV9hbmltU3BlZWQgPSAwO1xuXHQgIHRoaXMubV9hbmltUHRyID0gW107XG5cdCAgdGhpcy5tX2FuaW1OdW0gPSAwO1xuXHQgIHRoaXMubV9hbmltUHJpb3JpdHkgPSAtMTtcblx0ICB0aGlzLm1fc2NhbGUgPSAxLjA7XG5cdCAgdGhpcy5tX2xheWVyID0gMDtcblx0ICB0aGlzLm1fYkRyYXdUb0xheWVyID0gdHJ1ZTtcbiAgfVxuXG4gIGRlc3Ryb3koKSB7XG5cdCAgaWYgKHRoaXMubV9yZWNvcmRbMF0pIHtcblx0XHQgIEdhbWVPYmplY3QubV9wQ29sbGlkZS5yZW1vdmVPYmooXG4gICAgICAgIHRoaXMubV9yZWNvcmQgYXMgW3NSZWM8R2FtZU9iamVjdD4sIHNSZWM8R2FtZU9iamVjdD4sIHNSZWM8R2FtZU9iamVjdD4sIHNSZWM8R2FtZU9iamVjdD5dXG4gICAgICApXG4gICAgICB0aGlzLm1fcmVjb3JkID0gW3VuZGVmaW5lZCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIHVuZGVmaW5lZF1cbiAgICB9XG4gIH1cblxuICBzdGF0aWMgYXN5bmMgaW5pdFN0YXRpYygpIHtcblx0ICBjb25zb2xlLmFzc2VydCghR2FtZU9iamVjdC5tX3BDb2xsaWRlKVxuXHQgIEdhbWVPYmplY3QubV9wQ29sbGlkZSA9IG5ldyBBQUJCVGVzdGVyKClcblxuXHQgIC8vIExvYWQgc3ByaXRlIGNvb3Jkc1xuXG4gICAgR2FtZU9iamVjdC5tX3BpY3R1cmVzID0gYXdhaXQgUGljdHVyZXMubG9hZCgnbWVkaWEvc3ByaXRlcy50eHQnKVxuXG5cdCAgLy8gTG9hZCBhbmltIGRhdGFcbiAgICB0aGlzLm1fYW5pbXMgPSBhd2FpdCBmZXRjaCgnbWVkaWEvYW5pbS5qc29uJylcbiAgICAgIC50aGVuKHJlc3BvbnNlID0+IHJlc3BvbnNlLmpzb24oKSlcbiAgICAgIC50aGVuKGRhdGEgPT4gZGF0YSlcbiAgICAgIC5jYXRjaChlcnJvciA9PiB7IHRocm93KFwiRmFpbGVkIHRvIGxvYWQgbWVkaWEvYW5pbS50eHQ6IFwiICsgZXJyb3IpIH0pXG4gIH1cblxuICBnZXQgcm90YXRpb24oKSB7IHJldHVybiAwOyB9XG4gIFxuICBkcmF3KGN0eDogQ2FudmFzUmVuZGVyaW5nQ29udGV4dDJEKSB7XG4gICAgYXNzZXJ0KEdhbWVPYmplY3QubV9waWN0dXJlcylcblx0ICBjb25zdCBmID0gR2FtZU9iamVjdC5tX3BpY3R1cmVzLmdldEZyYW1lKHRoaXMubV9mcmFtZSlcblxuICAgIGN0eC50cmFuc2xhdGUodGhpcy5tX3Bvcy54IC0gZi53aWR0aCAvIDIsIHRoaXMubV9wb3MueSAtIGYuaGVpZ2h0LzIpXG4gICAgY3R4LnRyYW5zbGF0ZShmLndpZHRoIC8gMiwgZi5oZWlnaHQgLyAyKVxuICAgIGN0eC5zY2FsZSh0aGlzLm1fc2NhbGUsIHRoaXMubV9zY2FsZSlcbiAgICBjdHgucm90YXRlKHRoaXMucm90YXRpb24pXG4gICAgY3R4LnRyYW5zbGF0ZSgtZi53aWR0aCAvIDIsIC1mLmhlaWdodCAvIDIpXG4gICAgYXNzZXJ0KEdhbWVPYmplY3QubV9waWN0dXJlcylcbiAgICBcbiAgICBjdHguZHJhd0ltYWdlKFxuICAgICAgZi5pbWcsXG4gICAgICBmLngwLFxuICAgICAgZi55MCxcbiAgICAgIGYud2lkdGgsXG4gICAgICBmLmhlaWdodCxcbiAgICAgIDAsXG4gICAgICAwLFxuICAgICAgZi53aWR0aCxcbiAgICAgIGYuaGVpZ2h0XG4gICAgKVxuICB9XG5cblxuICBzZXRBbmltKGFuaW06IHN0cmluZywgc3BlZWQ6IG51bWJlciwgcHJpb3JpdHkgPSAtMSkge1xuXHQgIGNvbnN0IG5ld0FuaW0gPSBHYW1lT2JqZWN0Lm1fYW5pbXNbYW5pbV1cblxuXHQgIGNvbnNvbGUuYXNzZXJ0KG5ld0FuaW0gIT0gdW5kZWZpbmVkKVxuXG5cdCAgaWYgKG5ld0FuaW0gPT0gdGhpcy5tX2FuaW1QdHIpXG5cdCAge1xuXHRcdCAgdGhpcy5tX2FuaW1TcGVlZCA9IHNwZWVkXG5cdFx0ICB0aGlzLm1fYW5pbVByaW9yaXR5ID0gcHJpb3JpdHlcblx0XHQgIHJldHVyblxuXHQgIH1cblxuXHQgIGlmIChwcmlvcml0eSA+PSB0aGlzLm1fYW5pbVByaW9yaXR5KVxuXHQgIHtcblx0XHQgIHRoaXMubV9hbmltUHRyID0gbmV3QW5pbVxuXHRcdCAgLy8gcG9zaXRpb24gYXQgc3RhcnRcblx0XHQgIHRoaXMubV9hbmltUG9zID0gMDtcblxuXHRcdCAgdGhpcy5tX2FuaW1OdW0gPSB0aGlzLm1fYW5pbVB0ci5sZW5ndGg7XG5cdFx0ICB0aGlzLm1fYW5pbVNwZWVkID0gc3BlZWQ7XG5cdFx0ICB0aGlzLm1fYW5pbUxvb3BTdGFydCA9IDA7XG5cdFx0ICB0aGlzLm1fYW5pbVByaW9yaXR5ID0gcHJpb3JpdHk7XG5cblx0XHQgIGlmICh0aGlzLm1fYW5pbVB0cltNYXRoLmZsb29yKHRoaXMubV9hbmltUG9zKV0gPT0gLTIpXG5cdFx0ICB7XG5cdFx0XHQgIHRoaXMubV9hbmltUG9zKys7XG5cdFx0XHQgIHRoaXMubV9hbmltTG9vcFN0YXJ0ID0gdGhpcy5tX2FuaW1Qb3M7XG5cdFx0ICB9XG5cblx0XHQgIHRoaXMubV9mcmFtZSA9IHRoaXMubV9hbmltUHRyW01hdGguZmxvb3IodGhpcy5tX2FuaW1Qb3MpXTtcbiAgICAgIGFzc2VydCh0aGlzLm1fZnJhbWUgIT0gdW5kZWZpbmVkKVxuXHQgIH1cbiAgfVxuXG5cbiAgYW5pbWF0ZSgpIHtcblx0ICBjb25zb2xlLmFzc2VydCh0aGlzLm1fYW5pbVB0ciAhPSB1bmRlZmluZWQpO1xuXG5cdCAgdGhpcy5tX2FuaW1Eb25lID0gZmFsc2U7XG5cblx0ICBpZiAodGhpcy5tX2FuaW1Qb3MgPj0gdGhpcy5tX2FuaW1OdW0pXG5cdCAge1xuXHRcdCAgaWYgKHRoaXMubV9hbmltTG9vcFN0YXJ0KVxuXHRcdCAge1xuXHRcdFx0ICB0aGlzLm1fYW5pbVBvcyA9IHRoaXMubV9hbmltTG9vcFN0YXJ0O1xuXHRcdCAgfVxuXHRcdCAgZWxzZVxuXHRcdCAge1xuXHRcdFx0ICB0aGlzLm1fYW5pbVBvcyA9IHRoaXMubV9hbmltTnVtLTFcblx0XHRcdCAgdGhpcy5tX2FuaW1Eb25lID0gdHJ1ZVxuXHRcdCAgfVxuXHQgIH1cblxuXHQgIGlmICh0aGlzLm1fYW5pbVB0cltNYXRoLmZsb29yKHRoaXMubV9hbmltUG9zKV0gPT0gLTIpXG5cdCAge1xuXHRcdCAgdGhpcy5tX2FuaW1Qb3MrK1xuXHRcdCAgdGhpcy5tX2FuaW1Mb29wU3RhcnQgPSB0aGlzLm1fYW5pbVBvc1xuXHQgIH1cblxuXHQgIHRoaXMubV9mcmFtZSA9IHRoaXMubV9hbmltUHRyW01hdGguZmxvb3IodGhpcy5tX2FuaW1Qb3MpXVxuICAgIGFzc2VydCh0aGlzLm1fZnJhbWUgIT0gdW5kZWZpbmVkKVxuXG5cdCAgdGhpcy5tX2FuaW1Qcmlvcml0eSA9IC0xO1xuXG5cdCAgdGhpcy5tX2FuaW1Qb3MgKz0gdGhpcy5tX2FuaW1TcGVlZDtcbiAgfVxuXG5cdHByb3RlY3RlZCBtX2JEcmF3VG9MYXllcjogYm9vbGVhblxuXG4gIHByb3RlY3RlZCBlbnRlckNvbGxpc2lvblN5c3RlbSgpIHtcblx0ICB0aGlzLm1fcmVjb3JkID0gR2FtZU9iamVjdC5tX3BDb2xsaWRlLmFkZE9iaih0aGlzKVxuICB9XG4gIFxuICBwcm90ZWN0ZWQgYmVnaW5Nb3ZlKCkge1xuXHQgIHRoaXMubV9vbGRDb2xsaWRlUG9zID0gdGhpcy5tX3Bvc1xuICB9XG4gIFxuICBwcm90ZWN0ZWQgZW5kTW92ZSgpIHtcbiAgICBhc3NlcnQodGhpcy5tX3JlY29yZFswXSAhPSB1bmRlZmluZWQpXG5cdCAgR2FtZU9iamVjdC5tX3BDb2xsaWRlLm1vdmVPYmooXG4gICAgICB0aGlzLFxuICAgICAgdGhpcy5tX3Bvcy5taW51cyh0aGlzLm1fb2xkQ29sbGlkZVBvcyksXG4gICAgICB0aGlzLm1fcmVjb3JkIGFzIFtzUmVjPEdhbWVPYmplY3Q+LCBzUmVjPEdhbWVPYmplY3Q+LCBzUmVjPEdhbWVPYmplY3Q+LCBzUmVjPEdhbWVPYmplY3Q+XVxuICAgIClcbiAgfVxuXG5cdHByaXZhdGUgbV9hbmltUG9zOiBudW1iZXJcblx0cHJpdmF0ZSBtX2FuaW1TcGVlZDogbnVtYmVyXG5cdHByaXZhdGUgbV9hbmltTG9vcFN0YXJ0OiBudW1iZXIgPSAwXG5cdHByaXZhdGUgbV9hbmltUHRyOiBudW1iZXJbXVxuXHRwcml2YXRlIG1fYW5pbU51bTogbnVtYmVyXG5cdHByaXZhdGUgbV9hbmltUHJpb3JpdHk6IG51bWJlclxuXG5cdHByaXZhdGUgbV9hbmltRG9uZTogYm9vbGVhbiA9IGZhbHNlXG5cblx0cHJpdmF0ZSBtX29sZENvbGxpZGVQb3MgPSBuZXcgUG9pbnQyKClcblxuXHQvLyBXZSBuZWVkIHRvIGtlZXAgdHJhY2sgb2Ygb3VyIGNvbGxpc2lvbiByZWNvcmRzXG5cdHByaXZhdGUgbV9yZWNvcmQ6IFtzUmVjPEdhbWVPYmplY3Q+fHVuZGVmaW5lZCwgc1JlYzxHYW1lT2JqZWN0Pnx1bmRlZmluZWQsIHNSZWM8R2FtZU9iamVjdD58dW5kZWZpbmVkLFxuICAgICAgICAgICAgICAgICAgICAgc1JlYzxHYW1lT2JqZWN0Pnx1bmRlZmluZWRdID1cbiAgICBuZXcgQXJyYXk8c1JlYzxHYW1lT2JqZWN0Pj4oNCkgYXMgW3NSZWM8R2FtZU9iamVjdD4sIHNSZWM8R2FtZU9iamVjdD4sIHNSZWM8R2FtZU9iamVjdD4sIHNSZWM8R2FtZU9iamVjdD5dXG5cblx0cHJpdmF0ZSBzdGF0aWMgbV9hbmltczoge1trZXk6IHN0cmluZ106IG51bWJlcltdfVxuXHRwcml2YXRlIHN0YXRpYyBtX3BDb2xsaWRlOiBBQUJCVGVzdGVyXHRcdC8vIG93bmVyXG59XG4iXX0=