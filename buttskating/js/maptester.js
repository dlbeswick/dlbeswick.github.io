import { assert } from "./assert.js";
import { Bucket } from "./bucket.js";
import { CMap, sMapPart } from "./map.js";
import { Point } from "./point2.js";
import { g_App } from "./app.js";
export class MapTester {
    constructor() {
        this.m_colTest = [];
        this.m_colList = [];
        this.m_oldCamPos = Point(0, 0);
        this.m_camPart = new Map();
        this.m_bucketX = new Map();
        this.m_bucketY = new Map();
    }
    addObj(pObj) {
        assert(pObj);
        assert(pObj.w > 0 && pObj.h > 0);
        if (this.m_bucketX.get(pObj.layer) === undefined) {
            this.m_bucketX.set(pObj.layer, new Bucket());
            this.m_bucketY.set(pObj.layer, new Bucket());
            this.startCameraLayer(pObj.layer);
        }
        const newx = CMap.layerScale(pObj.x, pObj.layer);
        const newy = CMap.layerScale(pObj.y, pObj.layer);
        [this.m_colTest, pObj.colRec[0], pObj.colRec[1]] =
            this.m_bucketX.get(pObj.layer).addItem(this.m_colTest, pObj, newx, newx + pObj.width);
        [this.m_colTest, pObj.colRec[2], pObj.colRec[3]] =
            this.m_bucketY.get(pObj.layer).addItem(this.m_colTest, pObj, newy, newy + pObj.height);
        this.updateCollisions();
    }
    removeObj(pObj) {
        const pBucketX = this.m_bucketX.get(pObj.layer);
        assert(pBucketX);
        const pBucketY = this.m_bucketY.get(pObj.layer);
        assert(pBucketY);
        assert(pObj.colRec[0]);
        assert(pObj.colRec[1]);
        assert(pObj.colRec[2]);
        assert(pObj.colRec[3]);
        this.m_colTest = pBucketX.removeItem(this.m_colTest, pObj.colRec[0]);
        this.m_colTest = pBucketX.removeItem(this.m_colTest, pObj.colRec[1]);
        this.m_colTest = pBucketY.removeItem(this.m_colTest, pObj.colRec[2]);
        this.m_colTest = pBucketY.removeItem(this.m_colTest, pObj.colRec[3]);
        this.updateCollisions();
    }
    setCam(pos) {
        if (!this.m_oldCamPos.equals(pos)) {
            for (const key of this.m_bucketX.keys()) {
                const bx = this.m_bucketX.get(key);
                assert(bx);
                const by = this.m_bucketY.get(key);
                assert(by);
                const pPart = this.m_camPart.get(key);
                assert(pPart);
                const newPos = Point(CMap.layerScale(pos.x, key), CMap.layerScale(pos.y, key));
                const amt = newPos.minus(Point(pPart.x, pPart.y));
                assert(pPart.colRec[0]);
                assert(pPart.colRec[1]);
                assert(pPart.colRec[2]);
                assert(pPart.colRec[3]);
                this.m_colTest = bx.moveItem(this.m_colTest, pPart.colRec[0], amt.x);
                this.m_colTest = bx.moveItem(this.m_colTest, pPart.colRec[1], amt.x);
                this.m_colTest = by.moveItem(this.m_colTest, pPart.colRec[2], amt.y);
                this.m_colTest = by.moveItem(this.m_colTest, pPart.colRec[3], amt.y);
                pPart.x += amt.x;
                pPart.y += amt.y;
            }
            this.updateCollisions();
        }
        this.m_oldCamPos = pos;
    }
    clear() {
        this.m_bucketX = new Map();
        this.m_bucketY = new Map();
        this.m_camPart = new Map();
        this.m_colList.length = 0;
    }
    getColList() { return this.m_colList; }
    startCamera() {
        for (const layer of this.m_bucketX.keys()) {
            this.startCameraLayer(layer);
        }
        this.updateCollisions();
    }
    startCameraLayer(layer) {
        if (this.m_camPart.get(layer) === undefined) {
            this.m_camPart.set(layer, new sMapPart(CMap.layerScale(g_App.m_map.m_x, layer), CMap.layerScale(g_App.m_map.m_y, layer), 0, 0, 0, 0, undefined));
        }
        const pBucketX = this.m_bucketX.get(layer);
        assert(pBucketX);
        const pBucketY = this.m_bucketY.get(layer);
        assert(pBucketY);
        const pPart = this.m_camPart.get(layer);
        assert(pPart);
        pBucketX.setGhost(pPart);
        pBucketY.setGhost(pPart);
        [this.m_colTest, pPart.colRec[0], pPart.colRec[1]] =
            pBucketX.addItem(this.m_colTest, pPart, pPart.x, pPart.x + g_App.canvas.width);
        [this.m_colTest, pPart.colRec[2], pPart.colRec[3]] =
            pBucketY.addItem(this.m_colTest, pPart, pPart.y, pPart.y + g_App.canvas.height);
    }
    stopCamera() {
        for (const [key, bx] of this.m_bucketX.entries()) {
            bx.setGhost(undefined);
            const pPart = this.m_camPart.get(key);
            assert(pPart);
            assert(pPart.colRec[0]);
            assert(pPart.colRec[1]);
            this.m_colTest = bx.removeItem(this.m_colTest, pPart.colRec[0]);
            this.m_colTest = bx.removeItem(this.m_colTest, pPart.colRec[1]);
        }
        for (const [key, by] of this.m_bucketY.entries()) {
            by.setGhost(undefined);
            const pPart = this.m_camPart.get(key);
            assert(pPart);
            assert(pPart.colRec[2]);
            assert(pPart.colRec[3]);
            this.m_colTest = by.removeItem(this.m_colTest, pPart.colRec[2]);
            this.m_colTest = by.removeItem(this.m_colTest, pPart.colRec[3]);
        }
    }
    loadBinary(stream, partMap) {
        this.clear();
        let num = stream.uint;
        // read x bucket map
        for (let i = 0; i < num; i++) {
            const bucketNum = stream.int;
            const bucket = new Bucket();
            bucket.loadBinary(stream, partMap);
            this.m_bucketX.set(bucketNum, bucket);
        }
        // read y bucket map
        num = stream.uint;
        for (let i = 0; i < num; i++) {
            const bucketNum = stream.int;
            const bucket = new Bucket();
            bucket.loadBinary(stream, partMap);
            this.m_bucketY.set(bucketNum, bucket);
        }
        this.startCamera();
    }
    save() { throw ("Not implemented"); }
    updateCollisions() {
        // update collision set
        // a collision is indicated by 2 identical entries (x and y)
        this.m_colList.length = 0;
        for (const i of this.m_colTest) {
            if (i.bucketID == 2) {
                this.m_colList.push(i.second);
            }
        }
        this.m_colList.sort((a, b) => a.layer - b.layer || a.order - b.order);
    }
}
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWFwdGVzdGVyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vdHMvbWFwdGVzdGVyLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxhQUFhLENBQUE7QUFFcEMsT0FBTyxFQUFFLE1BQU0sRUFBWSxNQUFNLGFBQWEsQ0FBQTtBQUM5QyxPQUFPLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxNQUFNLFVBQVUsQ0FBQTtBQUN6QyxPQUFPLEVBQUUsS0FBSyxFQUFVLE1BQU0sYUFBYSxDQUFBO0FBQzNDLE9BQU8sRUFBRSxLQUFLLEVBQUUsTUFBTSxVQUFVLENBQUE7QUFFaEMsTUFBTSxPQUFPLFNBQVM7SUFBdEI7UUF3TFMsY0FBUyxHQUFHLEVBQTBCLENBQUM7UUFDdEMsY0FBUyxHQUFHLEVBQWdCLENBQUM7UUFDOUIsZ0JBQVcsR0FBRyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDO1FBRTFCLGNBQVMsR0FBRyxJQUFJLEdBQUcsRUFBb0IsQ0FBQTtRQUN2QyxjQUFTLEdBQUcsSUFBSSxHQUFHLEVBQTRCLENBQUE7UUFDL0MsY0FBUyxHQUFHLElBQUksR0FBRyxFQUE0QixDQUFBO0lBaUJ4RCxDQUFDO0lBOU1BLE1BQU0sQ0FBQyxJQUFjO1FBQ25CLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUNiLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsSUFBSSxJQUFJLENBQUMsQ0FBQyxHQUFHLENBQUMsQ0FBQyxDQUFDO1FBRWpDLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxLQUFLLFNBQVMsRUFDaEQ7WUFDQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksTUFBTSxFQUFFLENBQUMsQ0FBQztZQUM3QyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLElBQUksTUFBTSxFQUFFLENBQUMsQ0FBQTtZQUM1QyxJQUFJLENBQUMsZ0JBQWdCLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQ2xDO1FBRUQsTUFBTSxJQUFJLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUNqRCxNQUFNLElBQUksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRWpELENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDN0MsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBRSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksRUFBRSxJQUFJLEVBQUUsSUFBSSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMxRixDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzdDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUUsQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLElBQUksR0FBRyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUM7UUFFM0YsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7SUFDekIsQ0FBQztJQUVGLFNBQVMsQ0FBQyxJQUFjO1FBQ3RCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUMvQyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUE7UUFDakIsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQy9DLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQTtRQUVoQixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ3RCLE1BQU0sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7UUFDdEIsTUFBTSxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQTtRQUN0QixNQUFNLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ3ZCLElBQUksQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUNyRSxJQUFJLENBQUMsU0FBUyxHQUFHLFFBQVEsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7UUFDckUsSUFBSSxDQUFDLFNBQVMsR0FBRyxRQUFRLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1FBQ3JFLElBQUksQ0FBQyxTQUFTLEdBQUcsUUFBUSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUVyRSxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztJQUN6QixDQUFDO0lBRUYsTUFBTSxDQUFDLEdBQVc7UUFDaEIsSUFBSSxDQUFDLElBQUksQ0FBQyxXQUFXLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUNqQztZQUNDLEtBQUssTUFBTSxHQUFHLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsRUFDdkM7Z0JBQ0ksTUFBTSxFQUFFLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUE7Z0JBQ2xDLE1BQU0sQ0FBQyxFQUFFLENBQUMsQ0FBQTtnQkFDVixNQUFNLEVBQUUsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQTtnQkFDbEMsTUFBTSxDQUFDLEVBQUUsQ0FBQyxDQUFBO2dCQUNiLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO2dCQUNuQyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUE7Z0JBRWhCLE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUE7Z0JBQzlFLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7Z0JBRTlDLE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7Z0JBQ3ZCLE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7Z0JBQ3ZCLE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7Z0JBQ3ZCLE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUE7Z0JBQzFCLElBQUksQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFBO2dCQUNwRSxJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEdBQUcsQ0FBQyxDQUFDLENBQUMsQ0FBQTtnQkFDcEUsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUE7Z0JBQ3BFLElBQUksQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDLFFBQVEsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFBO2dCQUVwRSxLQUFLLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDLENBQUE7Z0JBQ2hCLEtBQUssQ0FBQyxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsQ0FBQTthQUNoQjtZQUVELElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO1NBQ3hCO1FBRUQsSUFBSSxDQUFDLFdBQVcsR0FBRyxHQUFHLENBQUM7SUFDeEIsQ0FBQztJQUVGLEtBQUs7UUFDRixJQUFJLENBQUMsU0FBUyxHQUFHLElBQUksR0FBRyxFQUFFLENBQUE7UUFDMUIsSUFBSSxDQUFDLFNBQVMsR0FBRyxJQUFJLEdBQUcsRUFBRSxDQUFBO1FBQzFCLElBQUksQ0FBQyxTQUFTLEdBQUcsSUFBSSxHQUFHLEVBQUUsQ0FBQTtRQUMxQixJQUFJLENBQUMsU0FBUyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUE7SUFDM0IsQ0FBQztJQUVGLFVBQVUsS0FBMEIsT0FBTyxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQztJQUU1RCxXQUFXO1FBQ1QsS0FBSyxNQUFNLEtBQUssSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksRUFBRSxFQUN6QztZQUNDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUM3QjtRQUVELElBQUksQ0FBQyxnQkFBZ0IsRUFBRSxDQUFDO0lBQ3pCLENBQUM7SUFFRixnQkFBZ0IsQ0FBQyxLQUFhO1FBQzVCLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLEtBQUssU0FBUyxFQUMzQztZQUNDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUNkLEtBQUssRUFDTCxJQUFJLFFBQVEsQ0FDVixJQUFJLENBQUMsVUFBVSxDQUFDLEtBQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxFQUMxQyxJQUFJLENBQUMsVUFBVSxDQUFDLEtBQU0sQ0FBQyxLQUFLLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxFQUN0QyxDQUFDLEVBQ0QsQ0FBQyxFQUNELENBQUMsRUFDRCxDQUFDLEVBQ0QsU0FBUyxDQUNWLENBQ0YsQ0FBQTtTQUNIO1FBRUQsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsS0FBSyxDQUFDLENBQUM7UUFDMUMsTUFBTSxDQUFDLFFBQVEsQ0FBQyxDQUFBO1FBQ2pCLE1BQU0sUUFBUSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQzFDLE1BQU0sQ0FBQyxRQUFRLENBQUMsQ0FBQTtRQUVqQixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxLQUFLLENBQUMsQ0FBQztRQUN2QyxNQUFNLENBQUMsS0FBSyxDQUFDLENBQUE7UUFFZCxRQUFRLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBQ3pCLFFBQVEsQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7UUFFekIsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMvQyxRQUFRLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsS0FBSyxFQUFFLEtBQUssQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUMsR0FBRyxLQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDO1FBRW5GLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDaEQsUUFBUSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDLEdBQUcsS0FBTSxDQUFDLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQTtJQUNuRixDQUFDO0lBR0YsVUFBVTtRQUNSLEtBQUssTUFBTSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLE9BQU8sRUFBRSxFQUNoRDtZQUNDLEVBQUUsQ0FBQyxRQUFRLENBQUMsU0FBUyxDQUFDLENBQUE7WUFDdEIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDcEMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFBO1lBQ2IsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUN4QixNQUFNLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQzFCLElBQUksQ0FBQyxTQUFTLEdBQUcsRUFBRSxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUNoRSxJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7U0FDaEU7UUFDRCxLQUFLLE1BQU0sQ0FBQyxHQUFHLEVBQUUsRUFBRSxDQUFDLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsRUFDaEQ7WUFDQyxFQUFFLENBQUMsUUFBUSxDQUFDLFNBQVMsQ0FBQyxDQUFBO1lBQ3RCLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3BDLE1BQU0sQ0FBQyxLQUFLLENBQUMsQ0FBQTtZQUNiLE1BQU0sQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDeEIsTUFBTSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztZQUMxQixJQUFJLENBQUMsU0FBUyxHQUFHLEVBQUUsQ0FBQyxVQUFVLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxLQUFLLENBQUMsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLENBQUM7WUFDaEUsSUFBSSxDQUFDLFNBQVMsR0FBRyxFQUFFLENBQUMsVUFBVSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO1NBQ2hFO0lBQ0YsQ0FBQztJQUdGLFVBQVUsQ0FBQyxNQUFpQixFQUFFLE9BQThCO1FBQzFELElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUViLElBQUksR0FBRyxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUM7UUFFdEIsb0JBQW9CO1FBQ3BCLEtBQUssSUFBSSxDQUFDLEdBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLEVBQUUsQ0FBQyxFQUFFLEVBQzFCO1lBQ0MsTUFBTSxTQUFTLEdBQUcsTUFBTSxDQUFDLEdBQUcsQ0FBQztZQUMzQixNQUFNLE1BQU0sR0FBRyxJQUFJLE1BQU0sRUFBWSxDQUFBO1lBQ3JDLE1BQU0sQ0FBQyxVQUFVLENBQUMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxDQUFBO1lBRXBDLElBQUksQ0FBQyxTQUFTLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsQ0FBQTtTQUNyQztRQUVELG9CQUFvQjtRQUNwQixHQUFHLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztRQUNsQixLQUFLLElBQUksQ0FBQyxHQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsR0FBRyxFQUFFLENBQUMsRUFBRSxFQUMxQjtZQUNDLE1BQU0sU0FBUyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUM7WUFDM0IsTUFBTSxNQUFNLEdBQUcsSUFBSSxNQUFNLEVBQVksQ0FBQTtZQUNyQyxNQUFNLENBQUMsVUFBVSxDQUFDLE1BQU0sRUFBRSxPQUFPLENBQUMsQ0FBQTtZQUVwQyxJQUFJLENBQUMsU0FBUyxDQUFDLEdBQUcsQ0FBQyxTQUFTLEVBQUUsTUFBTSxDQUFDLENBQUE7U0FDckM7UUFFRCxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUE7SUFDbkIsQ0FBQztJQUVGLElBQUksS0FBSyxNQUFLLENBQUMsaUJBQWlCLENBQUMsQ0FBQSxDQUFDLENBQUM7SUFVM0IsZ0JBQWdCO1FBQ3RCLHVCQUF1QjtRQUN2Qiw0REFBNEQ7UUFDNUQsSUFBSSxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUcsQ0FBQyxDQUFBO1FBRXpCLEtBQUssTUFBTSxDQUFDLElBQUksSUFBSSxDQUFDLFNBQVMsRUFDOUI7WUFDQyxJQUFJLENBQUMsQ0FBQyxRQUFRLElBQUksQ0FBQyxFQUNuQjtnQkFDQyxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUM7YUFDOUI7U0FDRDtRQUVBLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxFQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxJQUFJLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFBO0lBQ3RFLENBQUM7Q0FDRjtBQUFBLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBhc3NlcnQgfSBmcm9tIFwiLi9hc3NlcnQuanNcIlxuaW1wb3J0IHsgQmluc3RyZWFtIH0gZnJvbSBcIi4vYmluc3RyZWFtLmpzXCJcbmltcG9ydCB7IEJ1Y2tldCwgc0NvbGxpZGUgfSBmcm9tIFwiLi9idWNrZXQuanNcIlxuaW1wb3J0IHsgQ01hcCwgc01hcFBhcnQgfSBmcm9tIFwiLi9tYXAuanNcIlxuaW1wb3J0IHsgUG9pbnQsIFBvaW50MiB9IGZyb20gXCIuL3BvaW50Mi5qc1wiXG5pbXBvcnQgeyBnX0FwcCB9IGZyb20gXCIuL2FwcC5qc1wiXG5cbmV4cG9ydCBjbGFzcyBNYXBUZXN0ZXIge1xuXHRhZGRPYmoocE9iajogc01hcFBhcnQpIHtcblx0ICBhc3NlcnQocE9iaik7XG5cdCAgYXNzZXJ0KHBPYmoudyA+IDAgJiYgcE9iai5oID4gMCk7XG5cblx0ICBpZiAodGhpcy5tX2J1Y2tldFguZ2V0KHBPYmoubGF5ZXIpID09PSB1bmRlZmluZWQpXG5cdCAge1xuXHRcdCAgdGhpcy5tX2J1Y2tldFguc2V0KHBPYmoubGF5ZXIsIG5ldyBCdWNrZXQoKSk7XG5cdFx0ICB0aGlzLm1fYnVja2V0WS5zZXQocE9iai5sYXllciwgbmV3IEJ1Y2tldCgpKVxuXHRcdCAgdGhpcy5zdGFydENhbWVyYUxheWVyKHBPYmoubGF5ZXIpO1xuXHQgIH1cblxuXHQgIGNvbnN0IG5ld3ggPSBDTWFwLmxheWVyU2NhbGUocE9iai54LCBwT2JqLmxheWVyKTtcblx0ICBjb25zdCBuZXd5ID0gQ01hcC5sYXllclNjYWxlKHBPYmoueSwgcE9iai5sYXllcik7XG5cblx0ICBbdGhpcy5tX2NvbFRlc3QsIHBPYmouY29sUmVjWzBdLCBwT2JqLmNvbFJlY1sxXV0gPVxuICAgICAgdGhpcy5tX2J1Y2tldFguZ2V0KHBPYmoubGF5ZXIpIS5hZGRJdGVtKHRoaXMubV9jb2xUZXN0LCBwT2JqLCBuZXd4LCBuZXd4ICsgcE9iai53aWR0aCk7XG5cdCAgW3RoaXMubV9jb2xUZXN0LCBwT2JqLmNvbFJlY1syXSwgcE9iai5jb2xSZWNbM11dID1cbiAgICAgIHRoaXMubV9idWNrZXRZLmdldChwT2JqLmxheWVyKSEuYWRkSXRlbSh0aGlzLm1fY29sVGVzdCwgcE9iaiwgbmV3eSwgbmV3eSArIHBPYmouaGVpZ2h0KTtcblxuXHQgIHRoaXMudXBkYXRlQ29sbGlzaW9ucygpO1xuICB9XG5cblx0cmVtb3ZlT2JqKHBPYmo6IHNNYXBQYXJ0KSB7XG5cdCAgY29uc3QgcEJ1Y2tldFggPSB0aGlzLm1fYnVja2V0WC5nZXQocE9iai5sYXllcik7XG4gICAgYXNzZXJ0KHBCdWNrZXRYKVxuXHQgIGNvbnN0IHBCdWNrZXRZID0gdGhpcy5tX2J1Y2tldFkuZ2V0KHBPYmoubGF5ZXIpO1xuICAgIGFzc2VydChwQnVja2V0WSlcblxuICAgIGFzc2VydChwT2JqLmNvbFJlY1swXSlcbiAgICBhc3NlcnQocE9iai5jb2xSZWNbMV0pXG4gICAgYXNzZXJ0KHBPYmouY29sUmVjWzJdKVxuICAgIGFzc2VydChwT2JqLmNvbFJlY1szXSlcblx0ICB0aGlzLm1fY29sVGVzdCA9IHBCdWNrZXRYLnJlbW92ZUl0ZW0odGhpcy5tX2NvbFRlc3QsIHBPYmouY29sUmVjWzBdKTtcblx0ICB0aGlzLm1fY29sVGVzdCA9IHBCdWNrZXRYLnJlbW92ZUl0ZW0odGhpcy5tX2NvbFRlc3QsIHBPYmouY29sUmVjWzFdKTtcblx0ICB0aGlzLm1fY29sVGVzdCA9IHBCdWNrZXRZLnJlbW92ZUl0ZW0odGhpcy5tX2NvbFRlc3QsIHBPYmouY29sUmVjWzJdKTtcblx0ICB0aGlzLm1fY29sVGVzdCA9IHBCdWNrZXRZLnJlbW92ZUl0ZW0odGhpcy5tX2NvbFRlc3QsIHBPYmouY29sUmVjWzNdKTtcblxuXHQgIHRoaXMudXBkYXRlQ29sbGlzaW9ucygpO1xuICB9XG5cblx0c2V0Q2FtKHBvczogUG9pbnQyKSB7XG5cdCAgaWYgKCF0aGlzLm1fb2xkQ2FtUG9zLmVxdWFscyhwb3MpKVxuXHQgIHtcblx0XHQgIGZvciAoY29uc3Qga2V5IG9mIHRoaXMubV9idWNrZXRYLmtleXMoKSlcblx0XHQgIHtcbiAgICAgICAgY29uc3QgYnggPSB0aGlzLm1fYnVja2V0WC5nZXQoa2V5KVxuICAgICAgICBhc3NlcnQoYngpXG4gICAgICAgIGNvbnN0IGJ5ID0gdGhpcy5tX2J1Y2tldFkuZ2V0KGtleSlcbiAgICAgICAgYXNzZXJ0KGJ5KVxuXHRcdFx0ICBjb25zdCBwUGFydCA9IHRoaXMubV9jYW1QYXJ0LmdldChrZXkpO1xuICAgICAgICBhc3NlcnQocFBhcnQpXG5cblx0XHRcdCAgY29uc3QgbmV3UG9zID0gUG9pbnQoQ01hcC5sYXllclNjYWxlKHBvcy54LCBrZXkpLCBDTWFwLmxheWVyU2NhbGUocG9zLnksIGtleSkpXG5cdFx0XHQgIGNvbnN0IGFtdCA9IG5ld1Bvcy5taW51cyhQb2ludChwUGFydC54LCBwUGFydC55KSlcblxuICAgICAgICBhc3NlcnQocFBhcnQuY29sUmVjWzBdKVxuICAgICAgICBhc3NlcnQocFBhcnQuY29sUmVjWzFdKVxuICAgICAgICBhc3NlcnQocFBhcnQuY29sUmVjWzJdKVxuICAgICAgICBhc3NlcnQocFBhcnQuY29sUmVjWzNdKVxuXHRcdFx0ICB0aGlzLm1fY29sVGVzdCA9IGJ4Lm1vdmVJdGVtKHRoaXMubV9jb2xUZXN0LCBwUGFydC5jb2xSZWNbMF0sIGFtdC54KVxuXHRcdFx0ICB0aGlzLm1fY29sVGVzdCA9IGJ4Lm1vdmVJdGVtKHRoaXMubV9jb2xUZXN0LCBwUGFydC5jb2xSZWNbMV0sIGFtdC54KVxuXHRcdFx0ICB0aGlzLm1fY29sVGVzdCA9IGJ5Lm1vdmVJdGVtKHRoaXMubV9jb2xUZXN0LCBwUGFydC5jb2xSZWNbMl0sIGFtdC55KVxuXHRcdFx0ICB0aGlzLm1fY29sVGVzdCA9IGJ5Lm1vdmVJdGVtKHRoaXMubV9jb2xUZXN0LCBwUGFydC5jb2xSZWNbM10sIGFtdC55KVxuXHRcdFx0ICBcblx0XHRcdCAgcFBhcnQueCArPSBhbXQueFxuXHRcdFx0ICBwUGFydC55ICs9IGFtdC55XG5cdFx0ICB9XG5cblx0XHQgIHRoaXMudXBkYXRlQ29sbGlzaW9ucygpO1xuXHQgIH1cblxuXHQgIHRoaXMubV9vbGRDYW1Qb3MgPSBwb3M7XG4gIH1cblxuXHRjbGVhcigpIHtcbiAgICB0aGlzLm1fYnVja2V0WCA9IG5ldyBNYXAoKVxuICAgIHRoaXMubV9idWNrZXRZID0gbmV3IE1hcCgpXG4gICAgdGhpcy5tX2NhbVBhcnQgPSBuZXcgTWFwKClcbiAgICB0aGlzLm1fY29sTGlzdC5sZW5ndGggPSAwXG4gIH1cbiAgXG5cdGdldENvbExpc3QoKTogcmVhZG9ubHkgc01hcFBhcnRbXSB7IHJldHVybiB0aGlzLm1fY29sTGlzdDsgfVxuXG5cdHN0YXJ0Q2FtZXJhKCkge1xuXHQgIGZvciAoY29uc3QgbGF5ZXIgb2YgdGhpcy5tX2J1Y2tldFgua2V5cygpKVxuXHQgIHtcblx0XHQgIHRoaXMuc3RhcnRDYW1lcmFMYXllcihsYXllcik7XG5cdCAgfVxuXG5cdCAgdGhpcy51cGRhdGVDb2xsaXNpb25zKCk7XG4gIH1cblxuXHRzdGFydENhbWVyYUxheWVyKGxheWVyOiBudW1iZXIpIHtcblx0ICBpZiAodGhpcy5tX2NhbVBhcnQuZ2V0KGxheWVyKSA9PT0gdW5kZWZpbmVkKVxuXHQgIHtcblx0XHQgIHRoaXMubV9jYW1QYXJ0LnNldChcbiAgICAgICAgbGF5ZXIsXG4gICAgICAgIG5ldyBzTWFwUGFydChcbiAgICAgICAgICBDTWFwLmxheWVyU2NhbGUoZ19BcHAhLm1fbWFwLm1feCwgbGF5ZXIpLFxuXHRcdCAgICAgIENNYXAubGF5ZXJTY2FsZShnX0FwcCEubV9tYXAubV95LCBsYXllciksXG4gICAgICAgICAgMCxcbiAgICAgICAgICAwLFxuICAgICAgICAgIDAsXG4gICAgICAgICAgMCxcbiAgICAgICAgICB1bmRlZmluZWRcbiAgICAgICAgKVxuICAgICAgKVxuXHQgIH1cblxuXHQgIGNvbnN0IHBCdWNrZXRYID0gdGhpcy5tX2J1Y2tldFguZ2V0KGxheWVyKTtcbiAgICBhc3NlcnQocEJ1Y2tldFgpXG5cdCAgY29uc3QgcEJ1Y2tldFkgPSB0aGlzLm1fYnVja2V0WS5nZXQobGF5ZXIpO1xuICAgIGFzc2VydChwQnVja2V0WSlcblxuXHQgIGNvbnN0IHBQYXJ0ID0gdGhpcy5tX2NhbVBhcnQuZ2V0KGxheWVyKTtcbiAgICBhc3NlcnQocFBhcnQpXG5cblx0ICBwQnVja2V0WC5zZXRHaG9zdChwUGFydCk7XG5cdCAgcEJ1Y2tldFkuc2V0R2hvc3QocFBhcnQpO1xuICAgIFxuXHQgIFt0aGlzLm1fY29sVGVzdCwgcFBhcnQuY29sUmVjWzBdLCBwUGFydC5jb2xSZWNbMV1dID1cbiAgICAgIHBCdWNrZXRYLmFkZEl0ZW0odGhpcy5tX2NvbFRlc3QsIHBQYXJ0LCBwUGFydC54LCBwUGFydC54ICsgZ19BcHAhLmNhbnZhcy53aWR0aCk7XG5cblx0ICBbdGhpcy5tX2NvbFRlc3QsIHBQYXJ0LmNvbFJlY1syXSwgcFBhcnQuY29sUmVjWzNdXSA9XG5cdCAgICBwQnVja2V0WS5hZGRJdGVtKHRoaXMubV9jb2xUZXN0LCBwUGFydCwgcFBhcnQueSwgcFBhcnQueSArIGdfQXBwIS5jYW52YXMuaGVpZ2h0KVxuICB9XG5cbiAgXG5cdHN0b3BDYW1lcmEoKSB7XG5cdCAgZm9yIChjb25zdCBba2V5LCBieF0gb2YgdGhpcy5tX2J1Y2tldFguZW50cmllcygpKVxuXHQgIHtcblx0XHQgIGJ4LnNldEdob3N0KHVuZGVmaW5lZClcblx0XHQgIGNvbnN0IHBQYXJ0ID0gdGhpcy5tX2NhbVBhcnQuZ2V0KGtleSk7XG4gICAgICBhc3NlcnQocFBhcnQpXG4gICAgICBhc3NlcnQocFBhcnQuY29sUmVjWzBdKTtcbiAgICAgIGFzc2VydChwUGFydC5jb2xSZWNbMV0pO1xuXHRcdCAgdGhpcy5tX2NvbFRlc3QgPSBieC5yZW1vdmVJdGVtKHRoaXMubV9jb2xUZXN0LCBwUGFydC5jb2xSZWNbMF0pO1xuXHRcdCAgdGhpcy5tX2NvbFRlc3QgPSBieC5yZW1vdmVJdGVtKHRoaXMubV9jb2xUZXN0LCBwUGFydC5jb2xSZWNbMV0pO1xuXHQgIH1cblx0ICBmb3IgKGNvbnN0IFtrZXksIGJ5XSBvZiB0aGlzLm1fYnVja2V0WS5lbnRyaWVzKCkpXG5cdCAge1xuXHRcdCAgYnkuc2V0R2hvc3QodW5kZWZpbmVkKVxuXHRcdCAgY29uc3QgcFBhcnQgPSB0aGlzLm1fY2FtUGFydC5nZXQoa2V5KTtcbiAgICAgIGFzc2VydChwUGFydClcbiAgICAgIGFzc2VydChwUGFydC5jb2xSZWNbMl0pO1xuICAgICAgYXNzZXJ0KHBQYXJ0LmNvbFJlY1szXSk7XG5cdFx0ICB0aGlzLm1fY29sVGVzdCA9IGJ5LnJlbW92ZUl0ZW0odGhpcy5tX2NvbFRlc3QsIHBQYXJ0LmNvbFJlY1syXSk7XG5cdFx0ICB0aGlzLm1fY29sVGVzdCA9IGJ5LnJlbW92ZUl0ZW0odGhpcy5tX2NvbFRlc3QsIHBQYXJ0LmNvbFJlY1szXSk7XG5cdCAgfVxuICB9XG5cblxuXHRsb2FkQmluYXJ5KHN0cmVhbTogQmluc3RyZWFtLCBwYXJ0TWFwOiBNYXA8bnVtYmVyLCBzTWFwUGFydD4pIHtcblx0ICB0aGlzLmNsZWFyKCk7XG5cblx0ICBsZXQgbnVtID0gc3RyZWFtLnVpbnQ7XG5cblx0ICAvLyByZWFkIHggYnVja2V0IG1hcFxuXHQgIGZvciAobGV0IGk9MDsgaSA8IG51bTsgaSsrKVxuXHQgIHtcblx0XHQgIGNvbnN0IGJ1Y2tldE51bSA9IHN0cmVhbS5pbnQ7XG4gICAgICBjb25zdCBidWNrZXQgPSBuZXcgQnVja2V0PHNNYXBQYXJ0PigpXG4gICAgICBidWNrZXQubG9hZEJpbmFyeShzdHJlYW0sIHBhcnRNYXApXG4gICAgICBcblx0XHQgIHRoaXMubV9idWNrZXRYLnNldChidWNrZXROdW0sIGJ1Y2tldClcblx0ICB9XG5cblx0ICAvLyByZWFkIHkgYnVja2V0IG1hcFxuXHQgIG51bSA9IHN0cmVhbS51aW50O1xuXHQgIGZvciAobGV0IGk9MDsgaSA8IG51bTsgaSsrKVxuXHQgIHtcblx0XHQgIGNvbnN0IGJ1Y2tldE51bSA9IHN0cmVhbS5pbnQ7XG4gICAgICBjb25zdCBidWNrZXQgPSBuZXcgQnVja2V0PHNNYXBQYXJ0PigpXG4gICAgICBidWNrZXQubG9hZEJpbmFyeShzdHJlYW0sIHBhcnRNYXApXG4gICAgICBcblx0XHQgIHRoaXMubV9idWNrZXRZLnNldChidWNrZXROdW0sIGJ1Y2tldClcblx0ICB9XG5cblx0ICB0aGlzLnN0YXJ0Q2FtZXJhKClcbiAgfVxuICBcblx0c2F2ZSgpIHsgdGhyb3coXCJOb3QgaW1wbGVtZW50ZWRcIikgfVxuXG5cdHByaXZhdGUgbV9jb2xUZXN0ID0gW10gYXMgc0NvbGxpZGU8c01hcFBhcnQ+W107XG4gIHByaXZhdGUgbV9jb2xMaXN0ID0gW10gYXMgc01hcFBhcnRbXTtcblx0cHJpdmF0ZSBtX29sZENhbVBvcyA9IFBvaW50KDAsIDApO1xuXHRcblx0cHJpdmF0ZSBtX2NhbVBhcnQgPSBuZXcgTWFwPG51bWJlciwgc01hcFBhcnQ+KClcblx0cHJpdmF0ZSBtX2J1Y2tldFggPSBuZXcgTWFwPG51bWJlciwgQnVja2V0PHNNYXBQYXJ0Pj4oKVxuXHRwcml2YXRlIG1fYnVja2V0WSA9IG5ldyBNYXA8bnVtYmVyLCBCdWNrZXQ8c01hcFBhcnQ+PigpXG5cblx0cHJpdmF0ZSB1cGRhdGVDb2xsaXNpb25zKCkge1xuXHQgIC8vIHVwZGF0ZSBjb2xsaXNpb24gc2V0XG5cdCAgLy8gYSBjb2xsaXNpb24gaXMgaW5kaWNhdGVkIGJ5IDIgaWRlbnRpY2FsIGVudHJpZXMgKHggYW5kIHkpXG5cdCAgdGhpcy5tX2NvbExpc3QubGVuZ3RoID0gMFxuXG5cdCAgZm9yIChjb25zdCBpIG9mIHRoaXMubV9jb2xUZXN0KVxuXHQgIHtcblx0XHQgIGlmIChpLmJ1Y2tldElEID09IDIpXG5cdFx0ICB7XG5cdFx0XHQgIHRoaXMubV9jb2xMaXN0LnB1c2goaS5zZWNvbmQpO1xuXHRcdCAgfVxuXHQgIH1cblxuICAgIHRoaXMubV9jb2xMaXN0LnNvcnQoKGEsYikgPT4gYS5sYXllciAtIGIubGF5ZXIgfHwgYS5vcmRlciAtIGIub3JkZXIpXG4gIH1cbn07XG4iXX0=