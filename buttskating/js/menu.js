import { assert } from './assert.js';
import { EFonts } from './font.js';
import { g_App, STATE } from "./app.js";
export class Menu {
    constructor() {
        this.m_menus = new Array();
        this.m_curMenu = "";
        this.m_curItem = "";
        this.m_select = 0;
    }
    countOf(menu) {
        return this.m_menus.filter(([m, i]) => m == menu).length;
    }
    update() {
        assert(this.m_curMenu != "");
        if (g_App.m_transition.isBusy())
            return;
        const c = g_App.m_input.bufferKey();
        if (c == "Enter") {
            this.handleSelect(this.m_curMenu, this.m_curItem);
        }
        else if (c == "ArrowUp") {
            if (this.m_select > 0) {
                this.m_select--;
                g_App.getSound().PlayWAV("MENU01");
            }
        }
        else if (c == "ArrowDown") {
            if (this.m_select < this.countOf(this.m_curMenu) - 1) {
                this.m_select++;
                g_App.getSound().PlayWAV("MENU01");
            }
        }
    }
    draw() {
        assert(this.m_curMenu != "");
        let itemNum = 0;
        const fontWidth = g_App.fonts.getWidth(EFonts.FONT_SYSTEM);
        const fontHeight = g_App.fonts.getHeight(EFonts.FONT_SYSTEM);
        const num = this.countOf(this.m_curMenu);
        let x = (g_App.canvas.width - (fontWidth * this.m_curMenu.length)) / 2;
        let y = 10;
        g_App.fonts.write(this.m_curMenu, x, y, EFonts.FONT_SYSTEM);
        y = (g_App.canvas.height - (fontHeight * num)) / 2;
        for (const [m, i] of this.m_menus.filter(([m, i]) => m == this.m_curMenu)) {
            x = (g_App.canvas.width - (fontWidth * i.length)) / 2;
            if (itemNum == this.m_select) {
                g_App.fonts.wobbly(i, x, y, EFonts.FONT_SYSTEM);
                this.m_curItem = i;
            }
            else {
                g_App.fonts.write(i, x, y, EFonts.FONT_SYSTEM);
            }
            y += fontHeight;
            itemNum++;
        }
    }
    addItem(menu, item) {
        this.m_menus.push([menu, item]);
    }
    changeItem(menu, item, newItem) {
        const m = this.m_menus.find(i => i[0] == menu && i[1] == item);
        assert(m);
        m[1] = newItem;
    }
    setMenu(menu) {
        const m = this.m_menus.find(i => i[0] == menu);
        assert(m);
        this.m_curMenu = menu;
        this.m_select = 0;
    }
    handleSelect(menu, item) {
        if (menu == "Main Menu") {
            if (item == "Start") {
                g_App.m_transition.goTransition(g_App.m_transition.BMPFADE, STATE.GAME, g_App.m_map.loadBinary("media/level1.map", true));
                g_App.getSound().PlayWAV("MISC02");
            }
            else if (item == "Options") {
                this.setMenu("Options");
                g_App.getSound().PlayWAV("MENU02");
            }
            else if (item == "Quit") {
                g_App.m_transition.goTransition(g_App.m_transition.SPIRALBLOCKS, STATE.QUIT, Promise.resolve());
                g_App.getSound().PlayWAV("MISC01");
            }
        }
        else if (menu == "Options") {
            if (item == "Skill : Easy") {
                this.changeItem("Options", "Skill : Easy", "Skill : Normal");
                g_App.getSound().PlayWAV("MISC03");
            }
            else if (item == "Skill : Normal") {
                this.changeItem("Options", "Skill : Normal", "Skill : Hard");
                g_App.getSound().PlayWAV("MISC03");
            }
            else if (item == "Skill : Hard") {
                this.changeItem("Options", "Skill : Hard", "Skill : Easy");
                g_App.getSound().PlayWAV("MISC03");
            }
            else if (item == "FX is on") {
                this.changeItem("Options", "FX is on", "FX is off");
                g_App.getSound().PlayWAV("MISC03");
            }
            else if (item == "FX is off") {
                this.changeItem("Options", "FX is off", "FX is on");
                g_App.getSound().PlayWAV("MISC03");
            }
            else if (item == "Music is on") {
                this.changeItem("Options", "Music is on", "Music is off");
                g_App.getSound().PlayWAV("MISC03");
            }
            else if (item == "Music is off") {
                this.changeItem("Options", "Music is off", "Music is on");
                g_App.getSound().PlayWAV("MISC03");
            }
            else if (item == "Back") {
                this.setMenu("Main Menu");
                g_App.getSound().PlayWAV("MENU02");
            }
        }
    }
}
;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVudS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3RzL21lbnUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGFBQWEsQ0FBQTtBQUNwQyxPQUFPLEVBQUUsTUFBTSxFQUFFLE1BQU0sV0FBVyxDQUFBO0FBRWxDLE9BQU8sRUFBRSxLQUFLLEVBQUUsS0FBSyxFQUFFLE1BQU0sVUFBVSxDQUFBO0FBRXZDLE1BQU0sT0FBTyxJQUFJO0lBQWpCO1FBRVMsWUFBTyxHQUFHLElBQUksS0FBSyxFQUFvQixDQUFBO1FBQ3ZDLGNBQVMsR0FBVyxFQUFFLENBQUE7UUFDdEIsY0FBUyxHQUFXLEVBQUUsQ0FBQTtRQUV0QixhQUFRLEdBQVcsQ0FBQyxDQUFBO0lBOEo3QixDQUFDO0lBNUpTLE9BQU8sQ0FBQyxJQUFZO1FBQzFCLE9BQU8sSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsRUFBQyxDQUFDLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxDQUFDLE1BQU0sQ0FBQTtJQUN6RCxDQUFDO0lBRUYsTUFBTTtRQUNKLE1BQU0sQ0FBQyxJQUFJLENBQUMsU0FBUyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBRTdCLElBQUksS0FBTSxDQUFDLFlBQVksQ0FBQyxNQUFNLEVBQUU7WUFDL0IsT0FBTztRQUVSLE1BQU0sQ0FBQyxHQUFHLEtBQU0sQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLENBQUM7UUFFckMsSUFBSSxDQUFDLElBQUksT0FBTyxFQUNoQjtZQUNDLElBQUksQ0FBQyxZQUFZLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUM7U0FDbEQ7YUFDSSxJQUFJLENBQUMsSUFBSSxTQUFTLEVBQ3ZCO1lBQ0MsSUFBSSxJQUFJLENBQUMsUUFBUSxHQUFHLENBQUMsRUFDckI7Z0JBQ0MsSUFBSSxDQUFD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QUFDO2dCQUNwRCxLQUFNLENBQUMsUUFBUSxFQUFFLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQ3BDO2lCQUNJLElBQUksSUFBSSxJQUFJLGFBQWEsRUFDOUI7Z0JBQ0MsSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLEVBQUUsYUFBYSxFQUFFLGNBQWMsQ0FBQyxDQUFDO2dCQUMxRCxLQUFNLENBQUMsUUFBUSxFQUFFLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQ3BDO2lCQUNJLElBQUksSUFBSSxJQUFJLGNBQWMsRUFDL0I7Z0JBQ0MsSUFBSSxDQUFDLFVBQVUsQ0FBQyxTQUFTLEVBQUUsY0FBYyxFQUFFLGFBQWEsQ0FBQyxDQUFDO2dCQUMxRCxLQUFNLENBQUMsUUFBUSxFQUFFLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxDQUFDO2FBQ3BDO2lCQUNJLElBQUksSUFBSSxJQUFJLE1BQU0sRUFDdkI7Z0JBQ0MsSUFBSSxDQUFDLE9BQU8sQ0FBQyxXQUFXLENBQUMsQ0FBQztnQkFDMUIsS0FBTSxDQUFDLFFBQVEsRUFBRSxDQUFDLE9BQU8sQ0FBQyxRQUFRLENBQUMsQ0FBQzthQUNwQztTQUNEO0lBQ0YsQ0FBQztDQUNGO0FBQUEsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IGFzc2VydCB9IGZyb20gJy4vYXNzZXJ0LmpzJ1xuaW1wb3J0IHsgRUZvbnRzIH0gZnJvbSAnLi9mb250LmpzJ1xuaW1wb3J0IHsgVHJhbnNpdGlvbiB9IGZyb20gJy4vdHJhbnNpdGlvbi5qcydcbmltcG9ydCB7IGdfQXBwLCBTVEFURSB9IGZyb20gXCIuL2FwcC5qc1wiXG5cbmV4cG9ydCBjbGFzcyBNZW51XG57XG5cdHByaXZhdGUgbV9tZW51cyA9IG5ldyBBcnJheTxbc3RyaW5nLCBzdHJpbmddPigpXG5cdHByaXZhdGVcdG1fY3VyTWVudTogc3RyaW5nID0gXCJcIlxuXHRwcml2YXRlIG1fY3VySXRlbTogc3RyaW5nID0gXCJcIlxuXG5cdHByaXZhdGUgbV9zZWxlY3Q6IG51bWJlciA9IDBcbiAgXG4gIHByaXZhdGUgY291bnRPZihtZW51OiBzdHJpbmcpIHtcbiAgICByZXR1cm4gdGhpcy5tX21lbnVzLmZpbHRlcigoW20saV0pID0+IG0gPT0gbWVudSkubGVuZ3RoXG4gIH1cbiAgXG5cdHVwZGF0ZSgpIHtcblx0ICBhc3NlcnQodGhpcy5tX2N1ck1lbnUgIT0gXCJcIik7XG5cblx0ICBpZiAoZ19BcHAhLm1fdHJhbnNpdGlvbi5pc0J1c3koKSlcblx0XHQgIHJldHVybjtcblxuXHQgIGNvbnN0IGMgPSBnX0FwcCEubV9pbnB1dC5idWZmZXJLZXkoKTtcblxuXHQgIGlmIChjID09IFwiRW50ZXJcIilcblx0ICB7XG5cdFx0ICB0aGlzLmhhbmRsZVNlbGVjdCh0aGlzLm1fY3VyTWVudSwgdGhpcy5tX2N1ckl0ZW0pO1xuXHQgIH1cblx0ICBlbHNlIGlmIChjID09IFwiQXJyb3dVcFwiKVxuXHQgIHtcblx0XHQgIGlmICh0aGlzLm1fc2VsZWN0ID4gMClcblx0XHQgIHtcblx0XHRcdCAgdGhpcy5tX3NlbGVjdC0tO1xuXHRcdFx0ICBnX0FwcCEuZ2V0U291bmQoKS5QbGF5V0FWKFwiTUVOVTAxXCIpO1xuXHRcdCAgfVxuXHQgIH1cblx0ICBlbHNlIGlmIChjID09IFwiQXJyb3dEb3duXCIpXG5cdCAge1xuXHRcdCAgaWYgKHRoaXMubV9zZWxlY3QgPCB0aGlzLmNvdW50T2YodGhpcy5tX2N1ck1lbnUpIC0gMSlcblx0XHQgIHtcblx0XHRcdCAgdGhpcy5tX3NlbGVjdCsrO1xuXHRcdFx0ICBnX0FwcCEuZ2V0U291bmQoKS5QbGF5V0FWKFwiTUVOVTAxXCIpO1xuXHRcdCAgfVxuXHQgIH1cbiAgfVxuXG5cdGRyYXcoKSB7XG5cdCAgYXNzZXJ0KHRoaXMubV9jdXJNZW51ICE9IFwiXCIpO1xuXG5cdCAgbGV0IGl0ZW1OdW0gPSAwO1xuXG5cdCAgY29uc3QgZm9udFdpZHRoID0gZ19BcHAhIS5mb250cy5nZXRXaWR0aChFRm9udHMuRk9OVF9TWVNURU0pO1xuXHQgIGNvbnN0IGZvbnRIZWlnaHQgPSBnX0FwcCEhLmZvbnRzLmdldEhlaWdodChFRm9udHMuRk9OVF9TWVNURU0pO1xuXHQgIGNvbnN0IG51bSA9IHRoaXMuY291bnRPZih0aGlzLm1fY3VyTWVudSk7XG5cblx0ICBsZXQgeCA9IChnX0FwcCEhLmNhbnZhcy53aWR0aCAtIChmb250V2lkdGggKiB0aGlzLm1fY3VyTWVudS5sZW5ndGgpKSAvIDI7XG5cdCAgbGV0IHkgPSAxMDtcblxuXHQgIGdfQXBwISEuZm9udHMud3JpdGUodGhpcy5tX2N1ck1lbnUsIHgsIHksIEVGb250cy5GT05UX1NZU1RFTSk7XG5cblx0ICB5ID0gKGdfQXBwISEuY2FudmFzLmhlaWdodCAtIChmb250SGVpZ2h0ICogbnVtKSkgLyAyO1xuXG5cdCAgZm9yIChjb25zdCBbbSwgaV0gb2YgdGhpcy5tX21lbnVzLmZpbHRlcigoW20saV0pID0+IG0gPT0gdGhpcy5tX2N1ck1lbnUpKVxuXHQgIHtcblx0XHQgIHggPSAoZ19BcHAhIS5jYW52YXMud2lkdGggLSAoZm9udFdpZHRoICogaS5sZW5ndGgpKSAvIDI7XG5cblx0XHQgIGlmIChpdGVtTnVtID09IHRoaXMubV9zZWxlY3QpXG5cdFx0ICB7XG5cdFx0XHQgIGdfQXBwISEuZm9udHMud29iYmx5KGksIHgsIHksIEVGb250cy5GT05UX1NZU1RFTSk7XG5cdFx0XHQgIHRoaXMubV9jdXJJdGVtID0gaTtcblx0XHQgIH1cblx0XHQgIGVsc2Vcblx0XHQgIHtcblx0XHRcdCAgZ19BcHAhIS5mb250cy53cml0ZShpLCB4LCB5LCBFRm9udHMuRk9OVF9TWVNURU0pO1xuXHRcdCAgfVxuXG5cdFx0ICB5ICs9IGZvbnRIZWlnaHQ7XG5cblx0XHQgIGl0ZW1OdW0rKztcblx0ICB9XG4gIH1cblxuXHRhZGRJdGVtKG1lbnU6IHN0cmluZywgaXRlbTogc3RyaW5nKSB7XG5cdCAgdGhpcy5tX21lbnVzLnB1c2goW21lbnUsIGl0ZW1dKTtcbiAgfVxuICBcblx0Y2hhbmdlSXRlbShtZW51OiBzdHJpbmcsIGl0ZW06IHN0cmluZywgbmV3SXRlbTogc3RyaW5nKSB7XG4gICAgY29uc3QgbSA9IHRoaXMubV9tZW51cy5maW5kKGkgPT4gaVswXSA9PSBtZW51ICYmIGlbMV0gPT0gaXRlbSlcbiAgICBhc3NlcnQobSlcbiAgICBtWzFdID0gbmV3SXRlbVxuICB9XG4gIFxuXHRzZXRNZW51KG1lbnU6IHN0cmluZykge1xuICAgIGNvbnN0IG0gPSB0aGlzLm1fbWVudXMuZmluZChpID0+IGlbMF0gPT0gbWVudSlcblx0ICBhc3NlcnQobSlcblxuXHQgIHRoaXMubV9jdXJNZW51ID0gbWVudVxuXHQgIHRoaXMubV9zZWxlY3QgPSAwXG4gIH1cblxuXG5cdGhhbmRsZVNlbGVjdChtZW51OiBzdHJpbmcsIGl0ZW06IHN0cmluZykge1xuXHQgIGlmIChtZW51ID09IFwiTWFpbiBNZW51XCIpXG5cdCAge1xuXHRcdCAgaWYgKGl0ZW0gPT0gXCJTdGFydFwiKVxuXHRcdCAge1xuXHRcdFx0ICBnX0FwcCEubV90cmFuc2l0aW9uLmdvVHJhbnNpdGlvbihcbiAgICAgICAgICBnX0FwcCEubV90cmFuc2l0aW9uLkJNUEZBREUsXG4gICAgICAgICAgU1RBVEUuR0FNRSxcbiAgICAgICAgICBnX0FwcCEubV9tYXAubG9hZEJpbmFyeShcIm1lZGlhL2xldmVsMS5tYXBcIiwgdHJ1ZSlcbiAgICAgICAgKTtcblx0XHRcdCAgZ19BcHAhLmdldFNvdW5kKCkuUGxheVdBVihcIk1JU0MwMlwiKTtcblx0XHQgIH1cblx0XHQgIGVsc2UgaWYgKGl0ZW0gPT0gXCJPcHRpb25zXCIpXG5cdFx0ICB7XG5cdFx0XHQgIHRoaXMuc2V0TWVudShcIk9wdGlvbnNcIik7XG5cdFx0XHQgIGdfQXBwIS5nZXRTb3VuZCgpLlBsYXlXQVYoXCJNRU5VMDJcIik7XG5cdFx0ICB9XG5cdFx0ICBlbHNlIGlmIChpdGVtID09IFwiUXVpdFwiKVxuXHRcdCAge1xuXHRcdFx0ICBnX0FwcCEubV90cmFuc2l0aW9uLmdvVHJhbnNpdGlvbihnX0FwcCEubV90cmFuc2l0aW9uLlNQSVJBTEJMT0NLUywgU1RBVEUuUVVJVCwgUHJvbWlzZS5yZXNvbHZlKCkpXG5cdFx0XHQgIGdfQXBwIS5nZXRTb3VuZCgpLlBsYXlXQVYoXCJNSVNDMDFcIik7XG5cdFx0ICB9XG5cdCAgfVxuXHQgIGVsc2UgaWYgKG1lbnUgPT0gXCJPcHRpb25zXCIpXG5cdCAge1xuXHRcdCAgaWYgKGl0ZW0gPT0gXCJTa2lsbCA6IEVhc3lcIilcblx0XHQgIHtcblx0XHRcdCAgdGhpcy5jaGFuZ2VJdGVtKFwiT3B0aW9uc1wiLCBcIlNraWxsIDogRWFzeVwiLCBcIlNraWxsIDogTm9ybWFsXCIpO1xuXHRcdFx0ICBnX0FwcCEuZ2V0U291bmQoKS5QbGF5V0FWKFwiTUlTQzAzXCIpO1xuXHRcdCAgfVxuXHRcdCAgZWxzZSBpZiAoaXRlbSA9PSBcIlNraWxsIDogTm9ybWFsXCIpXG5cdFx0ICB7XG5cdFx0XHQgIHRoaXMuY2hhbmdlSXRlbShcIk9wdGlvbnNcIiwgXCJTa2lsbCA6IE5vcm1hbFwiLCBcIlNraWxsIDogSGFyZFwiKTtcblx0XHRcdCAgZ19BcHAhLmdldFNvdW5kKCkuUGxheVdBVihcIk1JU0MwM1wiKTtcblx0XHQgIH1cblx0XHQgIGVsc2UgaWYgKGl0ZW0gPT0gXCJTa2lsbCA6IEhhcmRcIilcblx0XHQgIHtcblx0XHRcdCAgdGhpcy5jaGFuZ2VJdGVtKFwiT3B0aW9uc1wiLCBcIlNraWxsIDogSGFyZFwiLCBcIlNraWxsIDogRWFzeVwiKTtcblx0XHRcdCAgZ19BcHAhLmdldFNvdW5kKCkuUGxheVdBVihcIk1JU0MwM1wiKTtcblx0XHQgIH1cblx0XHQgIGVsc2UgaWYgKGl0ZW0gPT0gXCJGWCBpcyBvblwiKVxuXHRcdCAge1xuXHRcdFx0ICB0aGlzLmNoYW5nZUl0ZW0oXCJPcHRpb25zXCIsIFwiRlggaXMgb25cIiwgXCJGWCBpcyBvZmZcIik7XG5cdFx0XHQgIGdfQXBwIS5nZXRTb3VuZCgpLlBsYXlXQVYoXCJNSVNDMDNcIik7XG5cdFx0ICB9XG5cdFx0ICBlbHNlIGlmIChpdGVtID09IFwiRlggaXMgb2ZmXCIpXG5cdFx0ICB7XG5cdFx0XHQgIHRoaXMuY2hhbmdlSXRlbShcIk9wdGlvbnNcIiwgXCJGWCBpcyBvZmZcIiwgXCJGWCBpcyBvblwiKTtcblx0XHRcdCAgZ19BcHAhLmdldFNvdW5kKCkuUGxheVdBVihcIk1JU0MwM1wiKTtcblx0XHQgIH1cblx0XHQgIGVsc2UgaWYgKGl0ZW0gPT0gXCJNdXNpYyBpcyBvblwiKVxuXHRcdCAge1xuXHRcdFx0ICB0aGlzLmNoYW5nZUl0ZW0oXCJPcHRpb25zXCIsIFwiTXVzaWMgaXMgb25cIiwgXCJNdXNpYyBpcyBvZmZcIik7XG5cdFx0XHQgIGdfQXBwIS5nZXRTb3VuZCgpLlBsYXlXQVYoXCJNSVNDMDNcIik7XG5cdFx0ICB9XG5cdFx0ICBlbHNlIGlmIChpdGVtID09IFwiTXVzaWMgaXMgb2ZmXCIpXG5cdFx0ICB7XG5cdFx0XHQgIHRoaXMuY2hhbmdlSXRlbShcIk9wdGlvbnNcIiwgXCJNdXNpYyBpcyBvZmZcIiwgXCJNdXNpYyBpcyBvblwiKTtcblx0XHRcdCAgZ19BcHAhLmdldFNvdW5kKCkuUGxheVdBVihcIk1JU0MwM1wiKTtcblx0XHQgIH1cblx0XHQgIGVsc2UgaWYgKGl0ZW0gPT0gXCJCYWNrXCIpXG5cdFx0ICB7XG5cdFx0XHQgIHRoaXMuc2V0TWVudShcIk1haW4gTWVudVwiKTtcblx0XHRcdCAgZ19BcHAhLmdldFNvdW5kKCkuUGxheVdBVihcIk1FTlUwMlwiKTtcblx0XHQgIH1cblx0ICB9XG4gIH1cbn07XG4iXX0=