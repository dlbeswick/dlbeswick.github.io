var __awaiter = (this && this.__awaiter) || function (thisArg, _arguments, P, generator) {
    function adopt(value) { return value instanceof P ? value : new P(function (resolve) { resolve(value); }); }
    return new (P || (P = Promise))(function (resolve, reject) {
        function fulfilled(value) { try { step(generator.next(value)); } catch (e) { reject(e); } }
        function rejected(value) { try { step(generator["throw"](value)); } catch (e) { reject(e); } }
        function step(result) { result.done ? resolve(result.value) : adopt(result.value).then(fulfilled, rejected); }
        step((generator = generator.apply(thisArg, _arguments || [])).next());
    });
};
import { assert } from './assert.js';
import { Pictures } from './pictures.js';
import { Point } from './point2.js';
import { g_App } from './app.js';
var TRANSITION_STATE;
(function (TRANSITION_STATE) {
    TRANSITION_STATE[TRANSITION_STATE["IDLE"] = 0] = "IDLE";
    TRANSITION_STATE[TRANSITION_STATE["INIT"] = 1] = "INIT";
    TRANSITION_STATE[TRANSITION_STATE["TRANSIN"] = 2] = "TRANSIN";
    TRANSITION_STATE[TRANSITION_STATE["WAITING"] = 3] = "WAITING";
    TRANSITION_STATE[TRANSITION_STATE["TRANSOUT"] = 4] = "TRANSOUT";
    TRANSITION_STATE[TRANSITION_STATE["DONE"] = 5] = "DONE";
})(TRANSITION_STATE || (TRANSITION_STATE = {}));
export class Transition {
    constructor() {
        this.NONE = 0;
        this.SPIRALBLOCKS = 1;
        this.BMPFADE = 2;
        this.m_appState = 0;
        this.m_state = TRANSITION_STATE.IDLE;
        this.m_method = this.NONE;
    }
    init() {
        return __awaiter(this, void 0, void 0, function* () {
            this.m_pictures = yield Pictures.load("media/transition.txt");
            this.m_pictures = this.m_pictures;
        });
    }
    goTransition(method, targetAppState, after) {
        Transition.m_bIsBusy = true;
        this.m_method = method;
        this.m_state = TRANSITION_STATE.INIT;
        this.m_appState = targetAppState;
        if (this.m_method == this.SPIRALBLOCKS) {
            this.m_func = this.doSpiralBlocks(after);
        }
        else if (this.m_method == this.BMPFADE) {
            this.m_func = this.doBMPFade(after);
        }
        else {
            assert(false);
        }
    }
    update() {
        if (this.m_state == TRANSITION_STATE.IDLE || this.m_method == this.NONE)
            return;
        const before = this.m_state;
        if (this.m_func)
            this.m_state = this.m_func(this.m_state);
        if (before != TRANSITION_STATE.TRANSOUT && this.m_state == TRANSITION_STATE.TRANSOUT) {
            Transition.m_bIsBusy = false;
            g_App.stateChange(this.m_appState);
        }
        if (this.m_state == TRANSITION_STATE.DONE) {
            this.m_state = TRANSITION_STATE.IDLE;
            this.m_method = this.NONE;
            this.m_func = undefined;
        }
    }
    isBusy() { return Transition.m_bIsBusy; }
    doSpiralBlocks(after) {
        let blocks = [];
        let dir;
        let count;
        assert(this.m_pictures);
        let g_pictures = this.m_pictures.rectData;
        let waiting = true;
        after.then(() => waiting = false).catch(() => waiting = false);
        return (state) => {
            if (state == TRANSITION_STATE.INIT) {
                blocks.length = 0;
                blocks.push(Point(0, 0));
                dir = 6;
                count = 1;
                state = TRANSITION_STATE.TRANSIN;
            }
            else if (state == TRANSITION_STATE.TRANSIN) {
                for (let n = 0; n < 20; n++) {
                    let lastX = blocks[blocks.length - 1].x;
                    let lastY = blocks[blocks.length - 1].y;
                    if (dir == 6) {
                        lastX += g_pictures[0].width;
                        if (lastX >= g_App.canvas.width - g_pictures[0].width * count) {
                            dir = 2;
                        }
                    }
                    else if (dir == 2) {
                        lastY += g_pictures[0].height;
                        if (lastY >= g_App.canvas.height - g_pictures[0].height * count) {
                            dir = 4;
                        }
                    }
                    else if (dir == 4) {
                        lastX -= g_pictures[0].width;
                        if (lastX <= g_pictures[0].width * (count - 1)) {
                            dir = 8;
                        }
                    }
                    else if (dir == 8) {
                        lastY -= g_pictures[0].height;
                        if (lastY <= g_pictures[0].height * count) {
                            count++;
                            dir = 6;
                        }
                    }
                    blocks.push(Point(lastX, lastY));
                }
                if (g_pictures[0].height * (count + 1) > g_App.canvas.height) {
                    state = TRANSITION_STATE.WAITING;
                }
            }
            else if (state == TRANSITION_STATE.WAITING) {
                if (waiting == false)
                    state = TRANSITION_STATE.TRANSOUT;
            }
            else if (state == TRANSITION_STATE.TRANSOUT) {
                for (const i of blocks) {
                    g_App.drawFrame(i.x, i.y, g_pictures[0]);
                }
                for (let n = 0; n < 20; n++) {
                    blocks.pop();
                    if (blocks.length == 0)
                        state = TRANSITION_STATE.DONE;
                }
            }
            for (const i of blocks) {
                g_App.drawFrame(i.x, i.y, g_pictures[0]);
            }
            return state;
        };
    }
    doBMPFade(after) {
        let x = 0;
        assert(this.m_pictures);
        const g_pictures = this.m_pictures.rectData;
        let waiting = true;
        after.then(() => waiting = false).catch(() => waiting = false);
        return (state) => {
            if (state == TRANSITION_STATE.INIT) {
                x = -640 - g_pictures[1].width;
                state = TRANSITION_STATE.TRANSIN;
            }
            else if (state == TRANSITION_STATE.TRANSIN) {
                if (x >= 0) {
                    x = -g_pictures[2].width;
                    state = TRANSITION_STATE.WAITING;
                }
                x += 20;
            }
            else if (state == TRANSITION_STATE.WAITING) {
                if (waiting == false)
                    state = TRANSITION_STATE.TRANSOUT;
            }
            else if (state == TRANSITION_STATE.TRANSOUT) {
                g_App.drawRect(x + g_pictures[2].width, 0, x + g_pictures[2].width + 640, 480, "black");
                for (let y = 0; y < 480; y += g_pictures[2].height) {
                    g_App.drawFrame(x, y, g_pictures[2]);
                }
                if (x >= 640)
                    state = TRANSITION_STATE.DONE;
                x += 20;
            }
            g_App.drawRect(x, 0, x + 640, 480, "black");
            for (let y = 0; y < 480; y += g_pictures[1].height) {
                g_App.drawFrame(x + 640, y, g_pictures[1]);
            }
            return state;
        };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidHJhbnNpdGlvbi5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uL3RzL3RyYW5zaXRpb24udHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7O0FBQUEsT0FBTyxFQUFFLE1BQU0sRUFBRSxNQUFNLGFBQWEsQ0FBQTtBQUNwQyxPQUFPLEVBQUUsUUFBUSxFQUFFLE1BQU0sZUFBZSxDQUFBO0FBQ3hDLE9BQU8sRUFBVSxLQUFLLEVBQUUsTUFBTSxhQUFhLENBQUE7QUFDM0MsT0FBTyxFQUFFLEtBQUssRUFBUyxNQUFNLFVBQVUsQ0FBQTtBQUV2QyxJQUFLLGdCQVFKO0FBUkQsV0FBSyxnQkFBZ0I7SUFFcEIsdURBQUksQ0FBQTtJQUNKLHVEQUFJLENBQUE7SUFDSiw2REFBTyxDQUFBO0lBQ1AsNkRBQU8sQ0FBQTtJQUNQLCtEQUFRLENBQUE7SUFDUix1REFBSSxDQUFBO0FBQ0wsQ0FBQyxFQVJJLGdCQUFnQixLQUFoQixnQkFBZ0IsUUFRcEI7QUFFRCxNQUFNLE9BQU8sVUFBVTtJQUV0QjtRQUtTLFNBQUksR0FBRyxDQUFDLENBQUE7UUFDUCxpQkFBWSxHQUFHLENBQUMsQ0FBQTtRQUNqQixZQUFPLEdBQUcsQ0FBQyxDQUFBO1FBaU5aLGVBQVUsR0FBVyxDQUFDLENBQUE7UUF2TjdCLElBQUksQ0FBQyxPQUFPLEdBQUcsZ0JBQWdCLENBQUMsSUFBSSxDQUFBO1FBQ3BDLElBQUksQ0FBQyxRQUFRLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQTtJQUMxQixDQUFDO0lBTUssSUFBSTs7WUFDUCxJQUFJLENBQUMsVUFBVSxHQUFHLE1BQU0sUUFBUSxDQUFDLElBQUksQ0FBQyxzQkFBc0IsQ0FBQyxDQUFBO1lBQzdELElBQUksQ0FBQyxVQUFVLEdBQUcsSUFBSSxDQUFDLFVBQVUsQ0FBQTtRQUNuQyxDQUFDO0tBQUE7SUFFRixZQUFZLENBQUMsTUFBYyxFQUFFLGNBQXNCLEVBQUUsS0FBbUI7UUFDdEUsVUFBVSxDQUFDLFNBQVMsR0FBRyxJ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dCB7IFBpY3R1cmVzIH0gZnJvbSAnLi9waWN0dXJlcy5qcydcbmltcG9ydCB7IFBvaW50MiwgUG9pbnQgfSBmcm9tICcuL3BvaW50Mi5qcydcbmltcG9ydCB7IGdfQXBwLCBTVEFURSB9IGZyb20gJy4vYXBwLmpzJ1xuXG5lbnVtIFRSQU5TSVRJT05fU1RBVEVcbntcblx0SURMRSxcblx0SU5JVCxcblx0VFJBTlNJTixcblx0V0FJVElORyxcblx0VFJBTlNPVVQsXG5cdERPTkVcbn1cblxuZXhwb3J0IGNsYXNzIFRyYW5zaXRpb25cbntcblx0Y29uc3RydWN0b3IoKVx0e1xuXHRcdHRoaXMubV9zdGF0ZSA9IFRSQU5TSVRJT05fU1RBVEUuSURMRVxuXHRcdHRoaXMubV9tZXRob2QgPSB0aGlzLk5PTkVcblx0fVxuXG5cdHJlYWRvbmx5IE5PTkUgPSAwXG4gIHJlYWRvbmx5IFNQSVJBTEJMT0NLUyA9IDFcblx0cmVhZG9ubHkgQk1QRkFERSA9IDJcblxuXHRhc3luYyBpbml0KCkge1xuICAgIHRoaXMubV9waWN0dXJlcyA9IGF3YWl0IFBpY3R1cmVzLmxvYWQoXCJtZWRpYS90cmFuc2l0aW9uLnR4dFwiKVxuICAgIHRoaXMubV9waWN0dXJlcyA9IHRoaXMubV9waWN0dXJlc1xuICB9XG4gIFxuXHRnb1RyYW5zaXRpb24obWV0aG9kOiBudW1iZXIsIHRhcmdldEFwcFN0YXRlOiBudW1iZXIsIGFmdGVyOiBQcm9taXNlPGFueT4pIHtcblx0ICBUcmFuc2l0aW9uLm1fYklzQnVzeSA9IHRydWVcblx0ICB0aGlzLm1fbWV0aG9kID0gbWV0aG9kXG5cdCAgdGhpcy5tX3N0YXRlID0gVFJBTlNJVElPTl9TVEFURS5JTklUXG5cdCAgdGhpcy5tX2FwcFN0YXRlID0gdGFyZ2V0QXBwU3RhdGVcblx0ICBpZiAodGhpcy5tX21ldGhvZCA9PSB0aGlzLlNQSVJBTEJMT0NLUylcblx0ICB7XG4gICAgICB0aGlzLm1fZnVuYyA9IHRoaXMuZG9TcGlyYWxCbG9ja3MoYWZ0ZXIpXG4gICAgfVxuXHQgIGVsc2UgaWYgKHRoaXMubV9tZXRob2QgPT0gdGhpcy5CTVBGQURFKVxuXHQgIHtcbiAgICAgIHRoaXMubV9mdW5jID0gdGhpcy5kb0JNUEZhZGUoYWZ0ZXIpXG4gICAgfVxuICAgIGVsc2VcbiAgICB7XG4gICAgICBhc3NlcnQoZmFsc2UpXG4gICAgfVxuICB9XG4gIFxuXHR1cGRhdGUoKSB7XG5cdCAgaWYgKHRoaXMubV9zdGF0ZSA9PSBUUkFOU0lUSU9OX1NUQVRFLklETEUgfHwgdGhpcy5tX21ldGhvZCA9PSB0aGlzLk5PTkUpXG5cdFx0ICByZXR1cm5cblxuXHQgIGNvbnN0IGJlZm9yZSA9IHRoaXMubV9zdGF0ZVxuXG4gICAgaWYgKHRoaXMubV9mdW5jKVxuICAgICAgdGhpcy5tX3N0YXRlID0gdGhpcy5tX2Z1bmModGhpcy5tX3N0YXRlKVxuXG5cdCAgaWYgKGJlZm9yZSAhPSBUUkFOU0lUSU9OX1NUQVRFLlRSQU5TT1VUICYmIHRoaXMubV9zdGF0ZSA9PSBUUkFOU0lUSU9OX1NUQVRFLlRSQU5TT1VUKVxuXHQgIHtcblx0XHQgIFRyYW5zaXRpb24ubV9iSXNCdXN5ID0gZmFsc2Vcblx0XHQgIGdfQXBwIS5zdGF0ZUNoYW5nZSh0aGlzLm1fYXBwU3RhdGUpXG5cdCAgfVxuXG5cdCAgaWYgKHRoaXMubV9zdGF0ZSA9PSBUUkFOU0lUSU9OX1NUQVRFLkRPTkUpXG5cdCAge1xuXHRcdCAgdGhpcy5tX3N0YXRlID0gVFJBTlNJVElPTl9TVEFURS5JRExFXG5cdFx0ICB0aGlzLm1fbWV0aG9kID0gdGhpcy5OT05FXG4gICAgICB0aGlzLm1fZnVuYyA9IHVuZGVmaW5lZFxuXHQgIH1cbiAgfVxuXG5cdGlzQnVzeSgpIHsgcmV0dXJuIFRyYW5zaXRpb24ubV9iSXNCdXN5IH1cblxuICBwcml2YXRlIGRvU3BpcmFsQmxvY2tzKGFmdGVyOiBQcm9taXNlPGFueT4pOiAoc3RhdGU6IFRSQU5TSVRJT05fU1RBVEUpID0+IFRSQU5TSVRJT05fU1RBVEUge1xuXHQgIGxldCBibG9ja3MgPSBbXSBhcyBQb2ludDJbXVxuXHQgIGxldCBkaXI6IG51bWJlclxuXHQgIGxldCBjb3VudDogbnVtYmVyXG4gICAgYXNzZXJ0KHRoaXMubV9waWN0dXJlcylcbiAgICBsZXQgZ19waWN0dXJlcyA9IHRoaXMubV9waWN0dXJlcy5yZWN0RGF0YVxuICAgIGxldCB3YWl0aW5nID0gdHJ1ZVxuXG4gICAgYWZ0ZXIudGhlbigoKSA9PiB3YWl0aW5nID0gZmFsc2UpLmNhdGNoKCgpID0+IHdhaXRpbmcgPSBmYWxzZSlcbiAgICBcbiAgICByZXR1cm4gKHN0YXRlKSA9PiB7XG5cdCAgICBpZiAoc3RhdGUgPT0gVFJBTlNJVElPTl9TVEFURS5JTklUKVxuXHQgICAge1xuXHRcdCAgICBibG9ja3MubGVuZ3RoID0gMFxuXHRcdCAgICBcblx0XHQgICAgYmxvY2tzLnB1c2goUG9pbnQoMCwgMCkpXG5cblx0XHQgICAgZGlyID0gNlxuXHRcdCAgICBjb3VudCA9IDFcblxuXHRcdCAgICBzdGF0ZSA9IFRSQU5TSVRJT05fU1RBVEUuVFJBTlNJTlxuXHQgICAgfVxuXHQgICAgZWxzZSBpZiAoc3RhdGUgPT0gVFJBTlNJVElPTl9TVEFURS5UUkFOU0lOKVxuXHQgICAge1xuXHRcdCAgICBmb3IgKGxldCBuPTA7IG4gPCAyMDsgbisrKVxuXHRcdCAgICB7XG5cdFx0XHQgICAgbGV0IGxhc3RYID0gYmxvY2tzW2Jsb2Nrcy5sZW5ndGgtMV0ueFxuXHRcdFx0ICAgIGxldCBsYXN0WSA9IGJsb2Nrc1tibG9ja3MubGVuZ3RoLTFdLnlcblxuXHRcdFx0ICAgIGlmIChkaXIgPT0gNilcblx0XHRcdCAgICB7XG5cdFx0XHRcdCAgICBsYXN0WCArPSBnX3BpY3R1cmVzWzBdLndpZHRoXG5cdFx0XHRcdCAgICBpZiAobGFzdFggPj0gZ19BcHAhLmNhbnZhcy53aWR0aCAtIGdfcGljdHVyZXNbMF0ud2lkdGggKiBjb3VudClcblx0XHRcdFx0ICAgIHtcblx0XHRcdFx0XHQgICAgZGlyID0gMlxuXHRcdFx0XHQgICAgfVxuXHRcdFx0ICAgIH1cblx0XHRcdCAgICBlbHNlIGlmIChkaXIgPT0gMilcblx0XHRcdCAgICB7XG5cdFx0XHRcdCAgICBsYXN0WSArPSBnX3BpY3R1cmVzWzBdLmhlaWdodFxuXHRcdFx0XHQgICAgaWYgKGxhc3RZID49IGdfQXBwIS5jYW52YXMuaGVpZ2h0IC0gZ19waWN0dXJlc1swXS5oZWlnaHQgKiBjb3VudClcblx0XHRcdFx0ICAgIHtcblx0XHRcdFx0XHQgICAgZGlyID0gNFxuXHRcdFx0XHQgICAgfVxuXHRcdFx0ICAgIH1cblx0XHRcdCAgICBlbHNlIGlmIChkaXIgPT0gNClcblx0XHRcdCAgICB7XG5cdFx0XHRcdCAgICBsYXN0WCAtPSBnX3BpY3R1cmVzWzBdLndpZHRoXG5cdFx0XHRcdCAgICBpZiAobGFzdFggPD0gZ19waWN0dXJlc1swXS53aWR0aCAqIChjb3VudCAtIDEpKVxuXHRcdFx0XHQgICAge1xuXHRcdFx0XHRcdCAgICBkaXIgPSA4XG5cdFx0XHRcdCAgICB9XG5cdFx0XHQgICAgfVxuXHRcdFx0ICAgIGVsc2UgaWYgKGRpciA9PSA4KVxuXHRcdFx0ICAgIHtcblx0XHRcdFx0ICAgIGxhc3RZIC09IGdfcGljdHVyZXNbMF0uaGVpZ2h0XG5cdFx0XHRcdCAgICBpZiAobGFzdFkgPD0gZ19waWN0dXJlc1swXS5oZWlnaHQgKiBjb3VudClcblx0XHRcdFx0ICAgIHtcblx0XHRcdFx0XHQgICAgY291bnQrK1xuXHRcdFx0XHRcdCAgICBkaXIgPSA2XG5cdFx0XHRcdCAgICB9XG5cdFx0XHQgICAgfVxuXG5cdFx0XHQgICAgYmxvY2tzLnB1c2goUG9pbnQobGFzdFgsIGxhc3RZKSlcblx0XHQgICAgfVxuXG5cdFx0ICAgIGlmIChnX3BpY3R1cmVzWzBdLmhlaWdodCAqIChjb3VudCsxKSA+IGdfQXBwIS5jYW52YXMuaGVpZ2h0KSB7XG4gICAgICAgICAgc3RhdGUgPSBUUkFOU0lUSU9OX1NUQVRFLldBSVRJTkdcbiAgICAgICAgfVxuXHQgICAgfVxuXHQgICAgZWxzZSBpZiAoc3RhdGUgPT0gVFJBTlNJVElPTl9TVEFURS5XQUlUSU5HKVxuICAgICAge1xuXHRcdFx0ICBpZiAod2FpdGluZyA9PSBmYWxzZSlcbiAgICAgICAgICBzdGF0ZSA9IFRSQU5TSVRJT05fU1RBVEUuVFJBTlNPVVRcbiAgICAgIH1cblx0ICAgIGVsc2UgaWYgKHN0YXRlID09IFRSQU5TSVRJT05fU1RBVEUuVFJBTlNPVVQpXG5cdCAgICB7XG5cdFx0ICAgIGZvciAoY29uc3QgaSBvZiBibG9ja3MpXG5cdFx0ICAgIHtcblx0XHRcdCAgICBnX0FwcCEuZHJhd0ZyYW1lKGkueCwgaS55LCBnX3BpY3R1cmVzWzBdKVxuXHRcdCAgICB9XG5cblx0XHQgICAgZm9yIChsZXQgbj0wOyBuIDwgMjA7IG4rKylcblx0XHQgICAge1xuXHRcdFx0ICAgIGJsb2Nrcy5wb3AoKVxuXG5cdFx0XHQgICAgaWYgKGJsb2Nrcy5sZW5ndGggPT0gMClcblx0XHRcdFx0ICAgIHN0YXRlID0gVFJBTlNJVElPTl9TVEFURS5ET05FXG5cdFx0ICAgIH1cblx0ICAgIH1cblx0ICAgIFxuXHRcdCAgZm9yIChjb25zdCBpIG9mIGJsb2Nrcylcblx0XHQgIHtcblx0XHRcdCAgZ19BcHAhLmRyYXdGcmFtZShpLngsIGkueSwgZ19waWN0dXJlc1swXSlcblx0XHQgIH1cblx0ICAgIFxuXHQgICAgcmV0dXJuIHN0YXRlXG4gICAgfVxuICB9XG5cblxuICBkb0JNUEZhZGUoYWZ0ZXI6IFByb21pc2U8YW55Pik6IChzdGF0ZTogVFJBTlNJVElPTl9TVEFURSkgPT4gVFJBTlNJVElPTl9TVEFURSB7XG5cdCAgbGV0IHggPSAwXG4gICAgYXNzZXJ0KHRoaXMubV9waWN0dXJlcylcbiAgICBjb25zdCBnX3BpY3R1cmVzID0gdGhpcy5tX3BpY3R1cmVzLnJlY3REYXRhXG4gICAgbGV0IHdhaXRpbmcgPSB0cnVlXG5cbiAgICBhZnRlci50aGVuKCgpID0+IHdhaXRpbmcgPSBmYWxzZSkuY2F0Y2goKCkgPT4gd2FpdGluZyA9IGZhbHNlKVxuXG4gICAgcmV0dXJuIChzdGF0ZSkgPT4ge1xuICAgICAgaWYgKHN0YXRlID09IFRSQU5TSVRJT05fU1RBVEUuSU5JVClcbiAgICAgIHtcbiAgICAgICAgeCA9IC02NDAgLSBnX3BpY3R1cmVzWzFdLndpZHRoXG5cbiAgICAgICAgc3RhdGUgPSBUUkFOU0lUSU9OX1NUQVRFLlRSQU5TSU5cbiAgICAgIH1cbiAgICAgIGVsc2UgaWYgKHN0YXRlID09IFRSQU5TSVRJT05fU1RBVEUuVFJBTlNJTilcbiAgICAgIHtcbiAgICAgICAgaWYgKHggPj0gMClcbiAgICAgICAge1xuICAgICAgICAgIHggPSAtZ19waWN0dXJlc1syXS53aWR0aFxuICAgICAgICAgIHN0YXRlID0gVFJBTlNJVElPTl9TVEFURS5XQUlUSU5HXG4gICAgICAgIH1cblxuICAgICAgICB4Kz0yMFxuICAgICAgfVxuXHQgICAgZWxzZSBpZiAoc3RhdGUgPT0gVFJBTlNJVElPTl9TVEFURS5XQUlUSU5HKVxuICAgICAge1xuXHRcdFx0ICBpZiAod2FpdGluZyA9PSBmYWxzZSlcbiAgICAgICAgICBzdGF0ZSA9IFRSQU5TSVRJT05fU1RBVEUuVFJBTlNPVVRcbiAgICAgIH1cbiAgICAgIGVsc2UgaWYgKHN0YXRlID09IFRSQU5TSVRJT05fU1RBVEUuVFJBTlNPVVQpXG4gICAgICB7XG4gICAgICAgIGdfQXBwIS5kcmF3UmVjdCh4ICsgZ19waWN0dXJlc1syXS53aWR0aCwgMCwgeCArIGdfcGljdHVyZXNbMl0ud2lkdGggKyA2NDAsIDQ4MCwgXCJibGFja1wiKVxuXG4gICAgICAgIGZvciAobGV0IHkgPSAwOyB5IDwgNDgwOyB5ICs9IGdfcGljdHVyZXNbMl0uaGVpZ2h0KVxuICAgICAgICB7XG4gICAgICAgICAgZ19BcHAhLmRyYXdGcmFtZSh4LCB5LCBnX3BpY3R1cmVzWzJdKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHggPj0gNjQwKVxuICAgICAgICAgIHN0YXRlID0gVFJBTlNJVElPTl9TVEFURS5ET05FXG5cbiAgICAgICAgeCs9MjBcbiAgICAgIH1cblxuICAgICAgZ19BcHAhLmRyYXdSZWN0KHgsIDAsIHggKyA2NDAsIDQ4MCwgXCJibGFja1wiKVxuXG4gICAgICBmb3IgKGxldCB5ID0gMDsgeSA8IDQ4MDsgeSArPSBnX3BpY3R1cmVzWzFdLmhlaWdodClcbiAgICAgIHtcbiAgICAgICAgZ19BcHAhLmRyYXdGcmFtZSh4ICsgNjQwLCB5LCBnX3BpY3R1cmVzWzFdKVxuICAgICAgfVxuXG5cdCAgICByZXR1cm4gc3RhdGVcbiAgICB9XG4gIH1cbiAgXG5cdHByaXZhdGUgbV9waWN0dXJlcz86IFBpY3R1cmVzXG5cdHByaXZhdGUgbV9hcHBTdGF0ZTogbnVtYmVyID0gMFxuXHRwcml2YXRlIG1fbWV0aG9kOiBudW1iZXJcblx0cHJpdmF0ZSBzdGF0aWMgbV9iSXNCdXN5OiBib29sZWFuXG4gIHByaXZhdGUgbV9zdGF0ZTogVFJBTlNJVElPTl9TVEFURVxuICBwcml2YXRlIG1fZnVuYz86IChzdGF0ZTogVFJBTlNJVElPTl9TVEFURSkgPT4gVFJBTlNJVElPTl9TVEFURVxufVxuIl19