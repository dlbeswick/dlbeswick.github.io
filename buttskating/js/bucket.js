import * as array from "./array.js";
import { assert } from "./assert.js";
// stores collision records
export class sCollide {
    constructor(first, second) {
        this.first = first;
        this.second = second;
        this.bucketID = 0;
    }
}
export var EDGE;
(function (EDGE) {
    EDGE[EDGE["EDGE_BEGIN"] = 0] = "EDGE_BEGIN";
    EDGE[EDGE["EDGE_END"] = 1] = "EDGE_END";
})(EDGE || (EDGE = {}));
;
export class sRec {
    constructor(object, val, edge) {
        this.object = object;
        this.val = val;
        this.edge = edge;
    }
    it(list) {
        const result = list.indexOf(this);
        assert(result != -1);
        return result;
    }
    lessThan(b) {
        return this.val < b.val || (this.val == b.val && this.edge < b.edge);
    }
}
// bucket class
export class Bucket {
    constructor() {
        this.m_list = []; // owner
    }
    // Add an item to the bucket.
    addItem(colSet, object, edgeBegin, edgeEnd) {
        console.assert(edgeBegin < 1000000000 && edgeBegin > -1000000000);
        console.assert(edgeEnd < 1000000000 && edgeEnd > -1000000000);
        // Insert beginning edge
        const beg = new sRec(object, -1000000000, EDGE.EDGE_BEGIN);
        this.m_list.unshift(beg);
        const outBeg = beg;
        // Insert end edge
        const end = new sRec(object, -1000000000, EDGE.EDGE_END);
        this.m_list.unshift(end);
        const outEnd = end;
        // Move edges into place
        let amt = edgeEnd + 1000000000;
        colSet = this.moveItem(colSet, end, amt);
        amt = edgeBegin + 1000000000;
        colSet = this.moveItem(colSet, beg, amt);
        return [colSet, outBeg, outEnd];
    }
    removeItem(colSet, rec) {
        this.m_list = array.remove(this.m_list, rec);
        return colSet.filter(c => c.first != rec.object && c.second != rec.object);
    }
    // Move an item a certain amount.
    moveItem(colSet, rec, amt) {
        rec.val += amt;
        // Find the direction we moved in
        if (amt < 0) {
            let it = rec.it(this.m_list);
            if (it == 0)
                return colSet;
            let prev = it - 1;
            if (this.m_list[prev].lessThan(rec))
                return colSet;
            this.m_list = array.removeIdx(this.m_list, it);
            let idx = it - 1;
            for (; idx > -1; --idx) {
                // Check if we moved past this next record, if so update collisions
                if (rec.lessThan(this.m_list[idx])) {
                    colSet = this.updateItem(colSet, this.m_list[idx], rec);
                }
                else {
                    break;
                }
            }
            this.m_list = array.insertAt(this.m_list, idx + 1, rec);
        }
        else if (amt > 0) {
            let it = rec.it(this.m_list);
            let next = it + 1;
            if (next == this.m_list.length)
                return colSet;
            if (rec.lessThan(this.m_list[next]))
                return colSet;
            this.m_list = array.removeIdx(this.m_list, it);
            let idx = it;
            for (; idx != this.m_list.length; ++idx) {
                // Check if we moved past this next record, if so update collisions
                if (this.m_list[idx].lessThan(rec)) {
                    colSet = this.updateItem(colSet, rec, this.m_list[idx]);
                }
                else {
                    break;
                }
            }
            this.m_list = array.insertAt(this.m_list, idx, rec);
        }
        return colSet;
    }
    updateItem(colSet, rec, update) {
        if (rec.edge != update.edge && rec.object != update.object) {
            // End edge is always moved last, edges always moved in pairs, so BEGIN is used to
            // delete the old record and END used to add the new one
            if (rec.edge == EDGE.EDGE_END) {
                if (update.object == this.m_ghost) {
                    let swap = rec;
                    rec = update;
                    update = swap;
                }
                if (this.m_ghost && rec.object != this.m_ghost)
                    return colSet;
                let col = colSet.find(c => c.first == rec.object && c.second == update.object);
                if (!col) {
                    col = new sCollide(rec.object, update.object);
                    colSet.push(col);
                }
                ++col.bucketID;
            }
            else {
                if (update.object == this.m_ghost) {
                    let swap = rec;
                    rec = update;
                    update = swap;
                }
                if (this.m_ghost && rec.object != this.m_ghost)
                    return colSet;
                let col = colSet.find(c => c.first == rec.object && c.second == update.object);
                if (col) {
                    if (!col.bucketID) {
                        colSet = array.remove(colSet, col);
                    }
                    else {
                        --col.bucketID;
                    }
                }
            }
        }
        return colSet;
    }
    clear() { this.setGhost(undefined); }
    setGhost(obj) { this.m_ghost = obj; }
    save() { throw ("Not implemented"); }
    loadBinary(stream, resolveMap) {
        this.clear();
        let size = stream.uint;
        for (let i = 0; i < size; i++) {
            const ptr = stream.int;
            const obj = resolveMap.get(ptr);
            if (obj == undefined) {
                throw ("Collision data corrupt - no matching pointer found.");
            }
            const r = new sRec(obj, stream.int, stream.char);
            this.m_list.push(r);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYnVja2V0LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vdHMvYnVja2V0LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sS0FBSyxLQUFLLE1BQU0sWUFBWSxDQUFBO0FBQ25DLE9BQU8sRUFBRSxNQUFNLEVBQUUsTUFBTSxhQUFhLENBQUE7QUFJcEMsMkJBQTJCO0FBQzNCLE1BQU0sT0FBTyxRQUFRO0lBR3BCLFlBQXFCLEtBQWMsRUFBVyxNQUFlO1FBQXhDLFVBQUssR0FBTCxLQUFLLENBQVM7UUFBVyxXQUFNLEdBQU4sTUFBTSxDQUFTO1FBRjdELGFBQVEsR0FBVyxDQUFDLENBQUE7SUFHbkIsQ0FBQztDQUNGO0FBRUQsTUFBTSxDQUFOLElBQVksSUFJWDtBQUpELFdBQVksSUFBSTtJQUVmLDJDQUFjLENBQUE7SUFDZCx1Q0FBUSxDQUFBO0FBQ1QsQ0FBQyxFQUpXLElBQUksS0FBSixJQUFJLFFBSWY7QUFBQSxDQUFDO0FBRUYsTUFBTSxPQUFPLElBQUk7SUFDZixZQUNXLE1BQWUsRUFDbEIsR0FBVyxFQUNULElBQVU7UUFGVCxXQUFNLEdBQU4sTUFBTSxDQUFTO1FBQ2xCLFFBQUcsR0FBSCxHQUFHLENBQVE7UUFDVCxTQUFJLEdBQUosSUFBSSxDQUFNO0lBQ2pCLENBQUM7SUFFSixFQUFFLENBQUMsSUFBWTtRQUNiLE1BQU0sTUFBTSxHQUFHLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUE7UUFDakMsTUFBTSxDQUFDLE1BQU0sSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFBO1FBQ3BCLE9BQU8sTUFBTSxDQUFBO0lBQ2YsQ0FBQztJQUVELFFBQVEsQ0FBQyxDQUFPO1FBQ2QsT0FBTyxJQUFJLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUMsQ0FBQyxHQUFHLElBQUksSUFBSSxDQUFDLElBQUksR0FBRyxDQUFDLENBQUMsSUFBSSxDQUFD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VUFBZ0M7UUFDNUQsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBRWIsSUFBSSxJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztRQUV2QixLQUFLLElBQUksQ0FBQyxHQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxFQUFFLENBQUMsRUFBRSxFQUMzQjtZQUNHLE1BQU0sR0FBRyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUE7WUFDeEIsTUFBTSxHQUFHLEdBQUcsVUFBVSxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUVoQyxJQUFJLEdBQUcsSUFBSSxTQUFTLEVBQ3BCO2dCQUNDLE1BQUssQ0FBQyxxREFBcUQsQ0FBQyxDQUFDO2FBQzdEO1lBRUQsTUFBTSxDQUFDLEdBQUcsSUFBSSxJQUFJLENBQVUsR0FBRyxFQUFFLE1BQU0sQ0FBQyxHQUFHLEVBQUUsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDO1lBRTFELElBQUksQ0FBQyxNQUFNLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxDQUFBO1NBQ25CO0lBQ0YsQ0FBQztDQUlGIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgYXJyYXkgZnJvbSBcIi4vYXJyYXkuanNcIlxuaW1wb3J0IHsgYXNzZXJ0IH0gZnJvbSBcIi4vYXNzZXJ0LmpzXCJcbmltcG9ydCB7IEJpbnN0cmVhbSB9IGZyb20gXCIuL2JpbnN0cmVhbS5qc1wiXG5pbXBvcnQgeyBHYW1lT2JqZWN0IH0gZnJvbSBcIi4vZ2FtZW9iamVjdC5qc1wiXG5cbi8vIHN0b3JlcyBjb2xsaXNpb24gcmVjb3Jkc1xuZXhwb3J0IGNsYXNzIHNDb2xsaWRlPFRPYmplY3Q+IHtcblx0YnVja2V0SUQ6IG51bWJlciA9IDBcblxuXHRjb25zdHJ1Y3RvcihyZWFkb25seSBmaXJzdDogVE9iamVjdCwgcmVhZG9ubHkgc2Vjb25kOiBUT2JqZWN0KVxuXHR7fVxufVxuXG5leHBvcnQgZW51bSBFREdFXG57XG5cdEVER0VfQkVHSU4gPSAwLFxuXHRFREdFX0VORFxufTtcblxuZXhwb3J0IGNsYXNzIHNSZWM8VE9iamVjdD4ge1xuICBjb25zdHJ1Y3RvcihcbiAgICByZWFkb25seSBvYmplY3Q6IFRPYmplY3QsXG5cdCAgcHVibGljIHZhbDogbnVtYmVyLFxuXHQgIHJlYWRvbmx5IGVkZ2U6IEVER0VcbiAgKSB7fVxuXG4gIGl0KGxpc3Q6IHRoaXNbXSkge1xuICAgIGNvbnN0IHJlc3VsdCA9IGxpc3QuaW5kZXhPZih0aGlzKVxuICAgIGFzc2VydChyZXN1bHQgIT0gLTEpXG4gICAgcmV0dXJuIHJlc3VsdFxuICB9XG5cbiAgbGVzc1RoYW4oYjogdGhpcykge1xuICAgIHJldHVybiB0aGlzLnZhbCA8IGIudmFsIHx8ICh0aGlzLnZhbCA9PSBiLnZhbCAmJiB0aGlzLmVkZ2UgPCBiLmVkZ2UpXG4gIH1cbn1cblxuLy8gYnVja2V0IGNsYXNzXG5leHBvcnQgY2xhc3MgQnVja2V0PFRPYmplY3Q+XG57XG4gIC8vIEFkZCBhbiBpdGVtIHRvIHRoZSBidWNrZXQuXG4gIGFkZEl0ZW0oY29sU2V0OiBzQ29sbGlkZTxUT2JqZWN0PltdLCBvYmplY3Q6IFRPYmplY3QsIGVkZ2VCZWdpbjogbnVtYmVyLCBlZGdlRW5kOiBudW1iZXJcbiAgICAgICAgICk6IFtzQ29sbGlkZTxUT2JqZWN0PltdLCBzUmVjPFRPYmplY3Q+LCBzUmVjPFRPYmplY3Q+XSB7XG4gICAgXG5cdCAgY29uc29sZS5hc3NlcnQoZWRnZUJlZ2luIDwgMTAwMDAwMDAwMCAmJiBlZGdlQmVnaW4gPiAtMTAwMDAwMDAwMClcblx0ICBjb25zb2xlLmFzc2VydChlZGdlRW5kIDwgMTAwMDAwMDAwMCAmJiBlZGdlRW5kID4gLTEwMDAwMDAwMDApXG5cblx0ICAvLyBJbnNlcnQgYmVnaW5uaW5nIGVkZ2Vcblx0ICBjb25zdCBiZWcgPSBuZXcgc1JlYyhvYmplY3QsIC0xMDAwMDAwMDAwLCBFREdFLkVER0VfQkVHSU4pXG4gICAgdGhpcy5tX2xpc3QudW5zaGlmdChiZWcpXG5cdCAgY29uc3Qgb3V0QmVnID0gYmVnO1xuXG5cdCAgLy8gSW5zZXJ0IGVuZCBlZGdlXG5cdCAgY29uc3QgZW5kID0gbmV3IHNSZWMob2JqZWN0LCAtMTAwMDAwMDAwMCwgRURHRS5FREdFX0VORClcbiAgICB0aGlzLm1fbGlzdC51bnNoaWZ0KGVuZClcblx0ICBjb25zdCBvdXRFbmQgPSBlbmQ7XG5cblx0ICAvLyBNb3ZlIGVkZ2VzIGludG8gcGxhY2Vcblx0ICBsZXQgYW10ID0gZWRnZUVuZCArIDEwMDAwMDAwMDA7XG5cdCAgY29sU2V0ID0gdGhpcy5tb3ZlSXRlbShjb2xTZXQsIGVuZCwgYW10KTtcblx0ICBhbXQgPSBlZGdlQmVnaW4gKyAxMDAwMDAwMDAwO1xuXHQgIGNvbFNldCA9IHRoaXMubW92ZUl0ZW0oY29sU2V0LCBiZWcsIGFtdCk7XG5cbiAgICByZXR1cm4gW2NvbFNldCwgb3V0QmVnLCBvdXRFbmRdXG4gIH1cbiAgXG4gIHJlbW92ZUl0ZW0oY29sU2V0OiBzQ29sbGlkZTxUT2JqZWN0PltdLCByZWM6IHNSZWM8VE9iamVjdD4pOiBzQ29sbGlkZTxUT2JqZWN0PltdIHtcblx0ICB0aGlzLm1fbGlzdCA9IGFycmF5LnJlbW92ZSh0aGlzLm1fbGlzdCwgcmVjKVxuXHQgIHJldHVybiBjb2xTZXQuZmlsdGVyKGMgPT4gYy5maXJzdCAhPSByZWMub2JqZWN0ICYmIGMuc2Vjb25kICE9IHJlYy5vYmplY3QpXG4gIH1cbiBcbiAgLy8gTW92ZSBhbiBpdGVtIGEgY2VydGFpbiBhbW91bnQuXG4gIG1vdmVJdGVtKGNvbFNldDogc0NvbGxpZGU8VE9iamVjdD5bXSwgcmVjOiBzUmVjPFRPYmplY3Q+LCBhbXQ6IG51bWJlcik6IHNDb2xsaWRlPFRPYmplY3Q+W10ge1xuXHQgIHJlYy52YWwgKz0gYW10XG5cblx0ICAvLyBGaW5kIHRoZSBkaXJlY3Rpb24gd2UgbW92ZWQgaW5cblx0ICBpZiAoYW10IDwgMCkge1xuICAgICAgbGV0IGl0ID0gcmVjLml0KHRoaXMubV9saXN0KVxuXHRcdCAgaWYgKGl0ID09IDApXG5cdFx0XHQgIHJldHVybiBjb2xTZXQ7XG5cblx0XHQgIGxldCBwcmV2ID0gaXQgLSAxO1xuXG5cdFx0ICBpZiAodGhpcy5tX2xpc3RbcHJldl0ubGVzc1RoYW4ocmVjKSlcblx0XHRcdCAgcmV0dXJuIGNvbFNldDtcblxuICAgICAgdGhpcy5tX2xpc3QgPSBhcnJheS5yZW1vdmVJZHgodGhpcy5tX2xpc3QsIGl0KVxuICAgICAgXG5cdFx0ICBsZXQgaWR4ID0gaXQgLSAxXG4gICAgICBmb3IgKDsgaWR4ID4gLTE7IC0taWR4KSB7XG5cdFx0XHQgIC8vIENoZWNrIGlmIHdlIG1vdmVkIHBhc3QgdGhpcyBuZXh0IHJlY29yZCwgaWYgc28gdXBkYXRlIGNvbGxpc2lvbnNcblx0XHRcdCAgaWYgKHJlYy5sZXNzVGhhbih0aGlzLm1fbGlzdFtpZHhdKSkge1xuXHRcdFx0XHQgIGNvbFNldCA9IHRoaXMudXBkYXRlSXRlbShjb2xTZXQsIHRoaXMubV9saXN0W2lkeF0sIHJlYyk7XG5cdFx0XHQgIH0gZWxzZSB7XG5cdFx0XHRcdCAgYnJlYWtcblx0XHRcdCAgfVxuXHRcdCAgfVxuICAgICAgXG5cdFx0ICB0aGlzLm1fbGlzdCA9IGFycmF5Lmluc2VydEF0KHRoaXMubV9saXN0LCBpZHgrMSwgcmVjKVxuXHQgIH1cblx0ICBlbHNlIGlmIChhbXQgPiAwKVxuXHQgIHtcbiAgICAgIGxldCBpdCA9IHJlYy5pdCh0aGlzLm1fbGlzdClcblx0XHQgIGxldCBuZXh0ID0gaXQrMTtcblxuXHRcdCAgaWYgKG5leHQgPT0gdGhpcy5tX2xpc3QubGVuZ3RoKVxuXHRcdFx0ICByZXR1cm4gY29sU2V0O1xuXG5cdFx0ICBpZiAocmVjLmxlc3NUaGFuKHRoaXMubV9saXN0W25leHRdKSlcblx0XHRcdCAgcmV0dXJuIGNvbFNldDtcblxuICAgICAgdGhpcy5tX2xpc3QgPSBhcnJheS5yZW1vdmVJZHgodGhpcy5tX2xpc3QsIGl0KVxuXG4gICAgICBsZXQgaWR4ID0gaXRcblx0XHQgIGZvciAoOyBpZHggIT0gdGhpcy5tX2xpc3QubGVuZ3RoOyArK2lkeClcblx0XHQgIHtcblx0XHRcdCAgLy8gQ2hlY2sgaWYgd2UgbW92ZWQgcGFzdCB0aGlzIG5leHQgcmVjb3JkLCBpZiBzbyB1cGRhdGUgY29sbGlzaW9uc1xuXHRcdFx0ICBpZiAodGhpcy5tX2xpc3RbaWR4XS5sZXNzVGhhbihyZWMpKVxuXHRcdFx0ICB7XG5cdFx0XHRcdCAgY29sU2V0ID0gdGhpcy51cGRhdGVJdGVtKGNvbFNldCwgcmVjLCB0aGlzLm1fbGlzdFtpZHhdKTtcblx0XHRcdCAgfVxuXHRcdFx0ICBlbHNlXG5cdFx0XHQgIHtcblx0XHRcdFx0ICBicmVhaztcblx0XHRcdCAgfVxuXHRcdCAgfVxuXHRcdCAgdGhpcy5tX2xpc3QgPSBhcnJheS5pbnNlcnRBdCh0aGlzLm1fbGlzdCwgaWR4LCByZWMpXG5cdCAgfVxuXG4gICAgcmV0dXJuIGNvbFNldFxuICB9XG4gIFxuICB1cGRhdGVJdGVtKGNvbFNldDogc0NvbGxpZGU8VE9iamVjdD5bXSwgcmVjOiBzUmVjPFRPYmplY3Q+LCB1cGRhdGU6IHNSZWM8VE9iamVjdD4pOiBzQ29sbGlkZTxUT2JqZWN0PltdIHtcblx0ICBpZiAocmVjLmVkZ2UgIT0gdXBkYXRlLmVkZ2UgJiYgcmVjLm9iamVjdCAhPSB1cGRhdGUub2JqZWN0KVxuXHQgIHtcblx0XHQgIC8vIEVuZCBlZGdlIGlzIGFsd2F5cyBtb3ZlZCBsYXN0LCBlZGdlcyBhbHdheXMgbW92ZWQgaW4gcGFpcnMsIHNvIEJFR0lOIGlzIHVzZWQgdG9cblx0XHQgIC8vIGRlbGV0ZSB0aGUgb2xkIHJlY29yZCBhbmQgRU5EIHVzZWQgdG8gYWRkIHRoZSBuZXcgb25lXG5cdFx0ICBpZiAocmVjLmVkZ2UgPT0gRURHRS5FREdFX0VORClcblx0XHQgIHtcblx0XHRcdCAgaWYgKHVwZGF0ZS5vYmplY3QgPT0gdGhpcy5tX2dob3N0KVxuXHRcdFx0ICB7XG5cdFx0XHRcdCAgbGV0IHN3YXAgPSByZWNcbiAgICAgICAgICByZWMgPSB1cGRhdGVcbiAgICAgICAgICB1cGRhdGUgPSBzd2FwXG5cdFx0XHQgIH1cblx0XHRcdCAgaWYgKHRoaXMubV9naG9zdCAmJiByZWMub2JqZWN0ICE9IHRoaXMubV9naG9zdClcblx0XHRcdFx0ICByZXR1cm4gY29sU2V0O1xuXG4gICAgICAgIGxldCBjb2wgPSBjb2xTZXQuZmluZChjID0+IGMuZmlyc3QgPT0gcmVjLm9iamVjdCAmJiBjLnNlY29uZCA9PSB1cGRhdGUub2JqZWN0KVxuICAgICAgICBpZiAoIWNvbCkge1xuICAgICAgICAgIGNvbCA9IG5ldyBzQ29sbGlkZTxUT2JqZWN0PihyZWMub2JqZWN0LCB1cGRhdGUub2JqZWN0KVxuXHRcdFx0ICAgIGNvbFNldC5wdXNoKGNvbClcbiAgICAgICAgfVxuXHRcdFx0ICArK2NvbC5idWNrZXRJRFxuXHRcdCAgfVxuXHRcdCAgZWxzZVxuXHRcdCAge1xuXHRcdFx0ICBpZiAodXBkYXRlLm9iamVjdCA9PSB0aGlzLm1fZ2hvc3QpXG5cdFx0XHQgIHtcblx0XHRcdFx0ICBsZXQgc3dhcCA9IHJlY1xuICAgICAgICAgIHJlYyA9IHVwZGF0ZVxuICAgICAgICAgIHVwZGF0ZSA9IHN3YXBcblx0XHRcdCAgfVxuXHRcdFx0ICBpZiAodGhpcy5tX2dob3N0ICYmIHJlYy5vYmplY3QgIT0gdGhpcy5tX2dob3N0KVxuXHRcdFx0XHQgIHJldHVybiBjb2xTZXQ7XG5cbiAgICAgICAgbGV0IGNvbCA9IGNvbFNldC5maW5kKGMgPT4gYy5maXJzdCA9PSByZWMub2JqZWN0ICYmIGMuc2Vjb25kID09IHVwZGF0ZS5vYmplY3QpXG5cdFx0XHQgIGlmIChjb2wpXG5cdFx0XHQgIHtcblx0XHRcdFx0ICBpZiAoIWNvbC5idWNrZXRJRClcblx0XHRcdFx0ICB7XG5cdFx0XHRcdFx0ICBjb2xTZXQgPSBhcnJheS5yZW1vdmUoY29sU2V0LCBjb2wpXG5cdFx0XHRcdCAgfVxuXHRcdFx0XHQgIGVsc2Vcblx0XHRcdFx0ICB7XG5cdFx0XHRcdFx0ICAtLWNvbC5idWNrZXRJRFxuXHRcdFx0XHQgIH1cblx0XHRcdCAgfVxuXHRcdCAgfVxuXHQgIH1cblxuICAgIHJldHVybiBjb2xTZXRcbiAgfVxuXG5cdGNsZWFyKCkgeyB0aGlzLnNldEdob3N0KHVuZGVmaW5lZCkgfVxuXHRzZXRHaG9zdChvYmo/OiBUT2JqZWN0KSB7IHRoaXMubV9naG9zdCA9IG9iajsgfVxuXG5cdHNhdmUoKSB7IHRocm93KFwiTm90IGltcGxlbWVudGVkXCIpIH1cbiAgXG5cdGxvYWRCaW5hcnkoc3RyZWFtOiBCaW5zdHJlYW0sIHJlc29sdmVNYXA6IE1hcDxudW1iZXIsIFRPYmplY3Q+KSB7XG5cdCAgdGhpcy5jbGVhcigpO1xuXG5cdCAgbGV0IHNpemUgPSBzdHJlYW0udWludDtcblxuXHQgIGZvciAobGV0IGk9MDsgaSA8IHNpemU7IGkrKylcblx0ICB7XG4gICAgICBjb25zdCBwdHIgPSBzdHJlYW0uaW50XG5cdFx0ICBjb25zdCBvYmogPSByZXNvbHZlTWFwLmdldChwdHIpO1xuXG5cdFx0ICBpZiAob2JqID09IHVuZGVmaW5lZClcblx0XHQgIHtcblx0XHRcdCAgdGhyb3coXCJDb2xsaXNpb24gZGF0YSBjb3JydXB0IC0gbm8gbWF0Y2hpbmcgcG9pbnRlciBmb3VuZC5cIik7XG5cdFx0ICB9XG5cblx0XHQgIGNvbnN0IHIgPSBuZXcgc1JlYzxUT2JqZWN0PihvYmosIHN0cmVhbS5pbnQsIHN0cmVhbS5jaGFyKTtcblxuXHRcdCAgdGhpcy5tX2xpc3QucHVzaChyKVxuXHQgIH1cbiAgfVxuXG5cdHByaXZhdGUgbV9saXN0ID0gW10gYXMgc1JlYzxUT2JqZWN0PltdXHRcdC8vIG93bmVyXG5cdHByaXZhdGUgbV9naG9zdD86IFRPYmplY3Rcbn1cbiJdfQ==